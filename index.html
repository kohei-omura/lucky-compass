<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”® Lucky Compass - é–‹é‹ãƒŠãƒ“</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700;900&family=Zen+Old+Mincho:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #C9A84C;
            --gold-light: #F0D080;
            --deep: #0A0614;
            --purple: #1A0A2E;
            --violet: #2D1B5E;
            --accent: #8B5CF6;
            --rose: #FF6B9D;
            --text: #F0E6FF;
            --muted: #9A8AB0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Serif JP', serif;
            background: var(--deep);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .starfield { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
        .star {
            position: absolute; border-radius: 50%; background: white;
            animation: twinkle var(--dur,3s) infinite var(--delay,0s);
        }
        @keyframes twinkle {
            0%,100%{opacity:.2;transform:scale(1)} 50%{opacity:1;transform:scale(1.5)}
        }
        .shooting-star {
            position: absolute; width: 120px; height: 1px;
            background: linear-gradient(90deg, transparent, white, transparent);
            animation: shoot 6s linear infinite; opacity: 0;
        }
        @keyframes shoot {
            0%{transform:translateX(-200px) translateY(0) rotate(-30deg);opacity:0}
            10%{opacity:1} 90%{opacity:1}
            100%{transform:translateX(calc(100vw + 200px)) translateY(200px) rotate(-30deg);opacity:0}
        }
        .container { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 40px 0 30px; }
        .header-symbol { font-size: 3.5rem; display: block; margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        h1 {
            font-family: 'Zen Old Mincho', serif; font-size: 2rem; font-weight: 900;
            background: linear-gradient(135deg, var(--gold), var(--gold-light), var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; letter-spacing: .1em; margin-bottom: 8px;
        }
        .subtitle { font-size: .8rem; color: var(--muted); letter-spacing: .15em; }
        .info-bar { display: flex; gap: 10px; margin: 20px 0; }
        .info-chip {
            flex: 1; background: rgba(255,255,255,.04);
            border: 1px solid rgba(201,168,76,.2); border-radius: 12px; padding: 12px; text-align: center;
        }
        .info-chip .label { color: var(--gold); font-size: .65rem; letter-spacing: .1em; margin-bottom: 4px; }
        .info-chip .value { color: var(--text); font-weight: 700; font-size: .8rem; }
        .location-btn {
            width: 100%; padding: 14px;
            background: rgba(201,168,76,.1); border: 1px solid rgba(201,168,76,.3);
            border-radius: 12px; color: var(--gold); font-size: .85rem;
            font-family: 'Noto Serif JP', serif; cursor: pointer; margin-bottom: 12px; transition: all .2s;
        }
        .location-btn:hover { background: rgba(201,168,76,.2); }
        .location-btn.success { border-color: rgba(100,255,150,.4); color: #80FFB0; background: rgba(100,255,150,.05); }
        .settings-card {
            background: rgba(255,255,255,.03); border: 1px solid rgba(201,168,76,.15);
            border-radius: 20px; padding: 25px; margin: 15px 0;
        }
        .settings-title { font-size: .75rem; color: var(--gold); letter-spacing: .15em; margin-bottom: 20px; text-align: center; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: 1 / -1; }
        label { font-size: .7rem; color: var(--muted); letter-spacing: .1em; }
        select, input {
            background: rgba(255,255,255,.06); border: 1px solid rgba(201,168,76,.2);
            border-radius: 10px; color: var(--text); padding: 10px 12px; font-size: .8rem;
            font-family: 'Noto Serif JP', serif; width: 100%; appearance: none;
        }
        select:focus, input:focus { outline: none; border-color: var(--gold); }
        option { background: #1A0A2E; }
        .fortune-btn {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, #7C3AED, #C9A84C, #7C3AED);
            background-size: 200% 200%; border: none; border-radius: 16px; color: white;
            font-size: 1rem; font-family: 'Zen Old Mincho', serif; font-weight: 700;
            letter-spacing: .1em; cursor: pointer; margin: 20px 0;
            animation: gradientShift 3s ease infinite; position: relative; overflow: hidden;
        }
        @keyframes gradientShift {
            0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
        }
        .fortune-btn:active { transform: scale(.98); }
        .loading { display: none; text-align: center; padding: 50px 0; }
        .loading.show { display: block; }
        .crystal-ball { font-size: 4rem; animation: pulse 1s ease-in-out infinite; display: block; margin-bottom: 20px; }
        @keyframes pulse { 0%,100%{transform:scale(1);filter:brightness(1)} 50%{transform:scale(1.1);filter:brightness(1.3)} }
        .loading-text { color: var(--gold); font-size: .9rem; letter-spacing: .2em; animation: fade 1.5s ease-in-out infinite; }
        @keyframes fade { 0%,100%{opacity:.5} 50%{opacity:1} }
        .result { display: none; animation: fadeInUp .8s ease-out; }
        .result.show { display: block; }
        @keyframes fadeInUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
        .result-card {
            border-radius: 20px; padding: 25px; margin: 15px 0;
            position: relative; overflow: hidden;
        }
        .result-card::before {
            content: ''; position: absolute; inset: 0; border-radius: 20px; padding: 1px;
            background: linear-gradient(135deg, var(--gold), transparent, var(--accent));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
        }
        .card-overall { background: linear-gradient(135deg, rgba(201,168,76,.1), rgba(10,6,20,.8)); }
        .card-time { background: linear-gradient(135deg, rgba(201,168,76,.08), rgba(10,6,20,.8)); }
        .card-place { background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(10,6,20,.8)); }
        .card-food { background: linear-gradient(135deg, rgba(255,107,157,.1), rgba(10,6,20,.8)); }
        .card-divination { background: linear-gradient(135deg, rgba(45,27,94,.5), rgba(10,6,20,.8)); }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
        .card-icon {
            font-size: 1.8rem; width: 50px; height: 50px; display: flex;
            align-items: center; justify-content: center;
            background: rgba(255,255,255,.05); border-radius: 12px;
        }
        .card-title { font-family: 'Zen Old Mincho', serif; font-size: 1rem; color: var(--gold); letter-spacing: .1em; }
        .card-subtitle { font-size: .7rem; color: var(--muted); margin-top: 2px; }
        .overall-msg { font-size: .9rem; line-height: 1.8; color: var(--text); }
        .time-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .time-item { background: rgba(255,255,255,.04); border-radius: 12px; padding: 12px; text-align: center; }
        .time-range { font-size: .9rem; font-weight: 700; color: var(--gold); margin-bottom: 4px; }
        .time-score-val { font-size: 1.3rem; font-weight: 900; margin: 5px 0; }
        .time-label { font-size: .7rem; color: var(--muted); }
        .place-item {
            background: rgba(255,255,255,.04); border-radius: 14px; padding: 15px;
            margin-bottom: 10px; border-left: 3px solid var(--accent);
        }
        .place-rank { font-size: .65rem; color: var(--accent); letter-spacing: .1em; margin-bottom: 5px; }
        .place-name { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .place-nearby { font-size: .8rem; color: var(--gold); margin-bottom: 4px; }
        .place-reason { font-size: .75rem; color: var(--muted); line-height: 1.6; }
        .food-item {
            background: rgba(255,255,255,.04); border-radius: 14px; padding: 15px;
            margin-bottom: 10px; border-left: 3px solid var(--rose);
        }
        .food-rank { font-size: .65rem; color: var(--rose); letter-spacing: .1em; margin-bottom: 5px; }
        .food-name { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .food-shop { font-size: .8rem; color: var(--gold); margin-bottom: 4px; }
        .food-reason { font-size: .75rem; color: var(--muted); line-height: 1.6; }
        .div-item { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,.05); }
        .div-item:last-child { border-bottom: none; }
        .div-name { font-size: .7rem; color: var(--gold); letter-spacing: .1em; margin-bottom: 5px; }
        .div-text { font-size: .8rem; color: var(--text); line-height: 1.7; }
        .error-msg {
            background: rgba(255,100,100,.1); border: 1px solid rgba(255,100,100,.3);
            border-radius: 12px; padding: 15px; text-align: center;
            color: #FF8080; font-size: .85rem; margin: 15px 0; display: none;
        }
        .error-msg.show { display: block; }
        footer { text-align: center; padding: 30px 0; color: var(--muted); font-size: .7rem; letter-spacing: .1em; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--deep); }
        ::-webkit-scrollbar-thumb { background: var(--violet); border-radius: 4px; }
    </style>
</head>
<body>
<div class="starfield" id="starfield"></div>
<div class="container">
    <header>
        <span class="header-symbol">ğŸ”®</span>
        <h1>Lucky Compass</h1>
        <p class="subtitle">é–‹é‹ãƒŠãƒ“ â”€ å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ </p>
    </header>

    <div class="info-bar">
        <div class="info-chip">
            <div class="label">ğŸ“… æ—¥æ™‚</div>
            <div class="value" id="datetime-display">å–å¾—ä¸­...</div>
        </div>
        <div class="info-chip">
            <div class="label">ğŸ“ ä½ç½®</div>
            <div class="value" id="location-display">æœªå–å¾—</div>
        </div>
    </div>

    <button class="location-btn" id="location-btn" onclick="getLocation()">
        ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    </button>

    <div class="error-msg" id="error-msg"></div>

    <div class="settings-card">
        <div class="settings-title">âœ¦ ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ› âœ¦</div>
        <div class="form-row">
            <div class="form-group">
                <label>æ˜Ÿåº§</label>
                <select id="zodiac">
                    <option value="ç‰¡ç¾Šåº§">ç‰¡ç¾Šåº§ â™ˆ</option>
                    <option value="ç‰¡ç‰›åº§">ç‰¡ç‰›åº§ â™‰</option>
                    <option value="åŒå­åº§">åŒå­åº§ â™Š</option>
                    <option value="èŸ¹åº§">èŸ¹åº§ â™‹</option>
                    <option value="ç…å­åº§">ç…å­åº§ â™Œ</option>
                    <option value="ä¹™å¥³åº§">ä¹™å¥³åº§ â™</option>
                    <option value="å¤©ç§¤åº§">å¤©ç§¤åº§ â™</option>
                    <option value="è åº§">è åº§ â™</option>
                    <option value="å°„æ‰‹åº§">å°„æ‰‹åº§ â™</option>
                    <option value="å±±ç¾Šåº§">å±±ç¾Šåº§ â™‘</option>
                    <option value="æ°´ç“¶åº§">æ°´ç“¶åº§ â™’</option>
                    <option value="é­šåº§">é­šåº§ â™“</option>
                </select>
            </div>
            <div class="form-group">
                <label>è¡€æ¶²å‹</label>
                <select id="blood-type">
                    <option value="A">Aå‹</option>
                    <option value="B" selected>Bå‹</option>
                    <option value="O">Oå‹</option>
                    <option value="AB">ABå‹</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>å¹²æ”¯</label>
                <select id="eto">
                    <option value="å­">å­ï¼ˆã­ãšã¿ï¼‰</option>
                    <option value="ä¸‘">ä¸‘ï¼ˆã†ã—ï¼‰</option>
                    <option value="å¯…">å¯…ï¼ˆã¨ã‚‰ï¼‰</option>
                    <option value="å¯">å¯ï¼ˆã†ã•ãï¼‰</option>
                    <option value="è¾°">è¾°ï¼ˆãŸã¤ï¼‰</option>
                    <option value="å·³">å·³ï¼ˆã¸ã³ï¼‰</option>
                    <option value="åˆ">åˆï¼ˆã†ã¾ï¼‰</option>
                    <option value="æœª">æœªï¼ˆã²ã¤ã˜ï¼‰</option>
                    <option value="ç”³">ç”³ï¼ˆã•ã‚‹ï¼‰</option>
                    <option value="é…‰" selected>é…‰ï¼ˆã¨ã‚Šï¼‰</option>
                    <option value="æˆŒ">æˆŒï¼ˆã„ã¬ï¼‰</option>
                    <option value="äº¥">äº¥ï¼ˆã„ã®ã—ã—ï¼‰</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç”Ÿå¹´æœˆæ—¥</label>
                <input type="date" id="birthdate" value="1993-04-14">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group full">
                <label>ç¾åœ¨ã®å ´æ‰€ãƒ»çŠ¶æ³ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="situation" placeholder="ä¾‹ï¼šå®®å´å¸‚ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«ã€è‡ªå®…ã€å¤–å‡ºä¸­">
            </div>
        </div>
    </div>

    <button class="fortune-btn" onclick="startFortune()">
        âœ¨ ä»Šã“ã®å ´æ‰€ã®é‹å‹¢ã‚’å ã† âœ¨
    </button>

    <div class="loading" id="loading">
        <span class="crystal-ball">ğŸ”®</span>
        <div class="loading-text">æ˜Ÿã€…ã«å•ã„ã‹ã‘ã¦ã„ã¾ã™...</div>
    </div>

    <div class="result" id="result"></div>

    <footer>
        Powered by ã‚¯ãƒˆã¡ã‚ƒã‚“ ğŸ’« å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ <br>
        è¥¿æ´‹å æ˜Ÿè¡“ãƒ»å››æŸ±æ¨å‘½ãƒ»ä¹æ˜Ÿæ°—å­¦ãƒ»é¢¨æ°´ãƒ»ã‚¿ãƒ­ãƒƒãƒˆãƒ»æ•°ç§˜è¡“çµ±åˆ
    </footer>
</div>

<script>
// ========== æ˜Ÿç©ºç”Ÿæˆ ==========
const sf = document.getElementById('starfield');
for (let i = 0; i < 120; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random() * 2 + .5;
    s.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${Math.random()*3+2}s;--delay:${Math.random()*3}s;`;
    sf.appendChild(s);
}
for (let i = 0; i < 3; i++) {
    const ss = document.createElement('div');
    ss.className = 'shooting-star';
    ss.style.cssText = `top:${Math.random()*40}%;left:0;animation-delay:${i*4+Math.random()*4}s;animation-duration:${5+Math.random()*3}s;`;
    sf.appendChild(ss);
}

// ========== æ—¥æ™‚æ›´æ–° ==========
function updateDatetime() {
    const now = new Date();
    const m = now.getMonth()+1, d = now.getDate();
    const h = String(now.getHours()).padStart(2,'0');
    const min = String(now.getMinutes()).padStart(2,'0');
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    document.getElementById('datetime-display').textContent = `${m}/${d}(${days[now.getDay()]}) ${h}:${min}`;
}
updateDatetime();
setInterval(updateDatetime, 1000);

// ========== ä½ç½®æƒ…å ± ==========
let currentCoords = null;
let currentLocation = '';

function getLocation() {
    const btn = document.getElementById('location-btn');
    btn.textContent = 'ğŸ“ å–å¾—ä¸­...';
    btn.disabled = true;

    if (!navigator.geolocation) {
        showError('ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        btn.textContent = 'ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹';
        btn.disabled = false;
        return;
    }

    navigator.geolocation.getCurrentPosition(
        async pos => {
            currentCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentCoords.lat}&lon=${currentCoords.lon}&format=json&accept-language=ja`);
                const data = await res.json();
                const a = data.address;
                currentLocation = (a.city||a.town||a.village||a.county||'') + (a.suburb||a.neighbourhood||'');
                if (!currentLocation) currentLocation = `ç·¯åº¦${currentCoords.lat.toFixed(2)}`;
            } catch {
                currentLocation = `ç·¯åº¦${currentCoords.lat.toFixed(2)} çµŒåº¦${currentCoords.lon.toFixed(2)}`;
            }
            document.getElementById('location-display').textContent = currentLocation;
            document.getElementById('situation').value = currentLocation;
            btn.textContent = `âœ… ${currentLocation}`;
            btn.className = 'location-btn success';
            btn.disabled = false;
        },
        err => {
            showError('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            btn.textContent = 'ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹';
            btn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
}

function showError(msg) {
    const el = document.getElementById('error-msg');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

// ========== å…¨å è¡“è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ ==========

// ä¹æ˜Ÿæ°—å­¦ï¼šæœ¬å‘½æ˜Ÿ
function getKyusei(birthYear) {
    const base = (birthYear - 1) % 9;
    const stars = ['ä¹ç´«ç«æ˜Ÿ','ä¸€ç™½æ°´æ˜Ÿ','äºŒé»’åœŸæ˜Ÿ','ä¸‰ç¢§æœ¨æ˜Ÿ','å››ç·‘æœ¨æ˜Ÿ','äº”é»„åœŸæ˜Ÿ','å…­ç™½é‡‘æ˜Ÿ','ä¸ƒèµ¤é‡‘æ˜Ÿ','å…«ç™½åœŸæ˜Ÿ'];
    return stars[base % 9];
}

// æ•°ç§˜è¡“ï¼šãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹
function getLifePath(birthdate) {
    const digits = birthdate.replace(/-/g,'').split('').map(Number);
    let sum = digits.reduce((a,b)=>a+b,0);
    while (sum > 9 && sum !== 11 && sum !== 22) {
        sum = String(sum).split('').map(Number).reduce((a,b)=>a+b,0);
    }
    return sum;
}

// å››æŸ±æ¨å‘½ï¼šæ—¥å¹²
function getDayKan(now) {
    const base = new Date(2000,0,1);
    const diff = Math.floor((now - base) / 86400000);
    const kans = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    return kans[((diff % 10) + 10) % 10];
}

// å…­æ›œ
function getRokuyo(now) {
    const m = now.getMonth()+1, d = now.getDate();
    const idx = (m + d) % 6;
    return ['å¤§å®‰','èµ¤å£','å…ˆå‹','å‹å¼•','å…ˆè² ','ä»æ»…'][idx];
}

// æ˜Ÿåº§åˆ¥åŸºæœ¬é‹æ°—
const zodiacBase = {
    'ç‰¡ç¾Šåº§':{base:88,element:'ç«',planet:'ç«æ˜Ÿ',luckyColor:'èµ¤',luckyNum:9},
    'ç‰¡ç‰›åº§':{base:82,element:'åœŸ',planet:'é‡‘æ˜Ÿ',luckyColor:'ç·‘',luckyNum:6},
    'åŒå­åº§':{base:86,element:'é¢¨',planet:'æ°´æ˜Ÿ',luckyColor:'é»„',luckyNum:5},
    'èŸ¹åº§'  :{base:80,element:'æ°´',planet:'æœˆ',luckyColor:'ç™½',luckyNum:2},
    'ç…å­åº§':{base:90,element:'ç«',planet:'å¤ªé™½',luckyColor:'é‡‘',luckyNum:1},
    'ä¹™å¥³åº§':{base:84,element:'åœŸ',planet:'æ°´æ˜Ÿ',luckyColor:'èŒ¶',luckyNum:5},
    'å¤©ç§¤åº§':{base:85,element:'é¢¨',planet:'é‡‘æ˜Ÿ',luckyColor:'ãƒ”ãƒ³ã‚¯',luckyNum:6},
    'è åº§'  :{base:87,element:'æ°´',planet:'å†¥ç‹æ˜Ÿ',luckyColor:'é»’',luckyNum:8},
    'å°„æ‰‹åº§':{base:89,element:'ç«',planet:'æœ¨æ˜Ÿ',luckyColor:'ç´«',luckyNum:3},
    'å±±ç¾Šåº§':{base:83,element:'åœŸ',planet:'åœŸæ˜Ÿ',luckyColor:'é»’',luckyNum:8},
    'æ°´ç“¶åº§':{base:86,element:'é¢¨',planet:'å¤©ç‹æ˜Ÿ',luckyColor:'é’',luckyNum:4},
    'é­šåº§'  :{base:81,element:'æ°´',planet:'æµ·ç‹æ˜Ÿ',luckyColor:'æ°´è‰²',luckyNum:7}
};

// è¡€æ¶²å‹è£œæ­£
const bloodBonus = { 'A':3, 'B':5, 'O':4, 'AB':6 };

// å¹²æ”¯è£œæ­£
const etoBonus = {
    'å­':4,'ä¸‘':3,'å¯…':6,'å¯':5,'è¾°':7,'å·³':4,'åˆ':6,'æœª':3,'ç”³':5,'é…‰':6,'æˆŒ':4,'äº¥':5
};

// æ›œæ—¥åˆ¥é‹æ°—
const dayBonus = [3,5,4,7,6,8,7]; // æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ

// æ™‚é–“å¸¯åˆ¥é‹æ°—
function getHourScore(h) {
    const scores = [3,2,2,2,2,4,6,7,7,7,8,8,9,9,8,8,7,9,9,9,8,8,7,5];
    return scores[h] || 7;
}

// ãƒ©ãƒƒã‚­ãƒ¼å ´æ‰€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆã‚¨ãƒªã‚¢åˆ¥ï¼‰
const luckyPlaceDB = {
    'å®®å´': {
        spiritual: ['å®®å´ç¥å®®','é’å³¶ç¥ç¤¾','éµœæˆ¸ç¥å®®'],
        nature:    ['é’å³¶','å¤§æ·€å·æ²³å·æ•·','å®®å´çœŒç·åˆé‹å‹•å…¬åœ’'],
        shopping:  ['ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å®®å´','å®®å´ãƒ–ãƒ¼ã‚²ãƒ³ãƒ“ãƒªã‚¢ç©ºæ¸¯','ãƒ•ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ†å®®å´'],
        cafe:      ['ã‚«ãƒ•ã‚§ãƒ»ãƒ‰ãƒ»ã‚µãƒ‹ãƒ¼','ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹å®®å´åº—','ã‚³ãƒ¡ãƒ€çˆç²å®®å´'],
    },
    'default': {
        spiritual: ['è¿‘ãã®ç¥ç¤¾','åœ°åŸŸã®æ°ç¥æ§˜','ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆ'],
        nature:    ['è¿‘ãã®å…¬åœ’','å·æ²¿ã„ã®éŠæ­©é“','è‡ªç„¶è±Šã‹ãªå ´æ‰€'],
        shopping:  ['åœ°å…ƒã®ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«','å•†åº—è¡—','åœ°å…ƒã®ãƒãƒ¼ã‚±ãƒƒãƒˆ'],
        cafe:      ['åœ°å…ƒã®ã‚«ãƒ•ã‚§','ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹','ã‚³ãƒ¼ãƒ’ãƒ¼ã‚·ãƒ§ãƒƒãƒ—'],
    }
};

// ãƒ©ãƒƒã‚­ãƒ¼ãƒ•ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
const luckyFoodDB = {
    'ç«': [
        {name:'èµ¤ã„é£Ÿã¹ç‰©å…¨èˆ¬ï¼ˆã„ã¡ã”ãƒ»ãƒˆãƒãƒˆï¼‰',color:'èµ¤',shop:'ãƒ•ãƒ«ãƒ¼ãƒ„ãƒ‘ãƒ¼ãƒ©ãƒ¼ãƒ»ã‚«ãƒ•ã‚§',time:'æ˜¼ã€œå¤•æ–¹'},
        {name:'è¾›ã„æ–™ç†ï¼ˆéº»å©†è±†è…ãƒ»ã‚«ãƒ¬ãƒ¼ï¼‰',color:'èµ¤',shop:'ä¸­è¯æ–™ç†åº—ãƒ»ã‚¤ãƒ³ãƒ‰æ–™ç†åº—',time:'å¤•é£Ÿ'},
        {name:'ç„¼ãè‚‰ãƒ»ãƒãƒ¼ãƒ™ã‚­ãƒ¥ãƒ¼',color:'èµ¤è¤è‰²',shop:'ç„¼è‚‰åº—',time:'å¤•é£Ÿ'},
    ],
    'åœŸ': [
        {name:'æ ¹èœæ–™ç†ï¼ˆã‹ã¼ã¡ã‚ƒãƒ»ã•ã¤ã¾ã„ã‚‚ï¼‰',color:'é»„',shop:'å®šé£Ÿå±‹ãƒ»å’Œé£Ÿåº—',time:'æ˜¼é£Ÿ'},
        {name:'å’Œé£Ÿå®šé£Ÿï¼ˆé­šãƒ»é‡èœä¸­å¿ƒï¼‰',color:'èŒ¶',shop:'å’Œé£Ÿãƒ¬ã‚¹ãƒˆãƒ©ãƒ³',time:'æ˜¼ã€œå¤•é£Ÿ'},
        {name:'ãŠå‘³å™Œæ±å®šé£Ÿ',color:'èŒ¶',shop:'å’Œé£Ÿåº—ãƒ»å®šé£Ÿå±‹',time:'æœé£Ÿãƒ»æ˜¼é£Ÿ'},
    ],
    'é¢¨': [
        {name:'è»½é£Ÿãƒ»ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ',color:'é»„',shop:'ã‚«ãƒ•ã‚§ãƒ»ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒå°‚é–€åº—',time:'æœã€œæ˜¼'},
        {name:'ãƒãƒ¼ãƒ–ãŸã£ã·ã‚Šã‚µãƒ©ãƒ€',color:'ç·‘',shop:'ãƒ˜ãƒ«ã‚·ãƒ¼ç³»ã‚«ãƒ•ã‚§',time:'æ˜¼é£Ÿ'},
        {name:'ãƒ‘ã‚¹ã‚¿ãƒ»ãƒ”ã‚¶',color:'é»„',shop:'ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³',time:'æ˜¼ã€œå¤•é£Ÿ'},
    ],
    'æ°´': [
        {name:'æµ·é®®æ–™ç†ãƒ»ãŠå¯¿å¸',color:'ç™½',shop:'å¯¿å¸åº—ãƒ»æµ·é®®å±…é…’å±‹',time:'æ˜¼ã€œå¤•é£Ÿ'},
        {name:'ã†ã©ã‚“ãƒ»ãã°',color:'ç™½',shop:'ä¸¸äº€è£½éººãƒ»è®ƒå²ã†ã©ã‚“',time:'æ˜¼é£Ÿ'},
        {name:'ã„ã¡ã”ã‚¹ã‚¤ãƒ¼ãƒ„',color:'ãƒ”ãƒ³ã‚¯',shop:'ãƒ‡ã‚£ãƒƒãƒ‘ãƒ¼ãƒ€ãƒ³ãƒ»ã‚«ãƒ•ã‚§',time:'ãŠã‚„ã¤'},
    ],
};

// å ´æ‰€ã‚«ãƒ†ã‚´ãƒªâ†’æ–¹è§’ãƒãƒƒãƒ—
const directionMap = {
    spiritual:'åŒ—', nature:'æ±', shopping:'å—', cafe:'å—æ±'
};

// ========== ãƒ¡ã‚¤ãƒ³å ã„è¨ˆç®— ==========
function calculateFortune(zodiac, blood, eto, birthdate, situation, now) {
    const zData = zodiacBase[zodiac] || zodiacBase['ç‰¡ç¾Šåº§'];

    // åŸºæœ¬ã‚¹ã‚³ã‚¢è¨ˆç®—
    let base = zData.base;
    base += (bloodBonus[blood] || 4);
    base += (etoBonus[eto] || 4);
    base += dayBonus[now.getDay()];

    // ç”Ÿå¹´æœˆæ—¥ã«ã‚ˆã‚‹æ•°ç§˜è¡“è£œæ­£
    const lp = getLifePath(birthdate);
    base += (lp % 5);

    // æœˆç›¸è£œæ­£ï¼ˆæº€æœˆãƒ»æ–°æœˆä»˜è¿‘ï¼‰
    const moonPhase = getMoonPhase(now);
    base += moonPhase.bonus;

    // ä¹æ˜Ÿæ°—å­¦
    const birthYear = birthdate ? parseInt(birthdate.split('-')[0]) : 1993;
    const kyusei = getKyusei(birthYear);

    // å…­æ›œ
    const rokuyo = getRokuyo(now);
    const rokuyoBonus = {'å¤§å®‰':8,'å‹å¼•':5,'å…ˆå‹':4,'å…ˆè² ':3,'èµ¤å£':2,'ä»æ»…':1};
    base += (rokuyoBonus[rokuyo] || 4);

    // ã‚¹ã‚³ã‚¢èª¿æ•´
    base = Math.min(99, Math.max(65, base));

    // æ—¥å¹²
    const dayKan = getDayKan(now);

    // ãƒ©ãƒƒã‚­ãƒ¼ã‚¿ã‚¤ãƒ è¨ˆç®—
    const luckyTimes = calcLuckyTimes(now, zodiac, blood, eto);

    // ãƒ©ãƒƒã‚­ãƒ¼å ´æ‰€è¨ˆç®—
    const places = calcLuckyPlaces(zData.element, situation, now, base);

    // ãƒ©ãƒƒã‚­ãƒ¼ãƒ•ãƒ¼ãƒ‰è¨ˆç®—
    const foods = calcLuckyFoods(zData.element, zodiac, now, situation);

    // å è¡“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const divinations = generateDivinationMessages(zodiac, blood, eto, rokuyo, kyusei, lp, dayKan, moonPhase, base, now);

    // ç·åˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const overall = generateOverallMessage(zodiac, rokuyo, base, now, situation);

    return { base, luckyTimes, places, foods, divinations, overall, rokuyo, kyusei, lp, moonPhase };
}

// æœˆç›¸è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function getMoonPhase(now) {
    const knownNew = new Date(2000, 0, 6);
    const diff = (now - knownNew) / 86400000;
    const cycle = diff % 29.53;
    if (cycle < 1.5 || cycle > 28) return { phase:'æ–°æœˆ', emoji:'ğŸŒ‘', bonus:6 };
    if (cycle < 7.5) return { phase:'ä¸‰æ—¥æœˆ', emoji:'ğŸŒ’', bonus:4 };
    if (cycle < 9.5) return { phase:'ä¸Šå¼¦ã®æœˆ', emoji:'ğŸŒ“', bonus:5 };
    if (cycle < 14) return { phase:'åä¸‰å¤œ', emoji:'ğŸŒ”', bonus:6 };
    if (cycle < 16) return { phase:'æº€æœˆ', emoji:'ğŸŒ•', bonus:8 };
    if (cycle < 22) return { phase:'ä¸‹å¼¦ã®æœˆ', emoji:'ğŸŒ—', bonus:4 };
    return { phase:'æ™¦æ—¥æœˆ', emoji:'ğŸŒ˜', bonus:3 };
}

// ãƒ©ãƒƒã‚­ãƒ¼ã‚¿ã‚¤ãƒ è¨ˆç®—
function calcLuckyTimes(now, zodiac, blood, eto) {
    const h = now.getHours();
    const timeSlots = [
        { time:'6:00-9:00',  start:6  },
        { time:'9:00-12:00', start:9  },
        { time:'12:00-15:00',start:12 },
        { time:'15:00-18:00',start:15 },
        { time:'18:00-21:00',start:18 },
        { time:'21:00-24:00',start:21 },
    ];

    return timeSlots.map(slot => {
        let score = 70 + getHourScore(slot.start);
        // æ˜Ÿåº§åˆ¥ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ãƒ¯ãƒ¼è£œæ­£
        const zData = zodiacBase[zodiac];
        if (zData) {
            const ln = zData.luckyNum;
            if (slot.start % 3 === ln % 3) score += 5;
        }
        // ç¾åœ¨æ™‚åˆ»ã«è¿‘ã„æ™‚é–“ã¯ã‚¹ã‚³ã‚¢ã‚¢ãƒƒãƒ—
        if (Math.abs(slot.start - h) <= 2) score += 3;
        score = Math.min(99, score);
        const labels = ['ç©ã‚„ã‹ãªæ™‚é–“','è‰¯ã„æµã‚Œ','ä¸Šæ˜‡ä¸­','çµ¶å¥½èª¿','ãƒ”ãƒ¼ã‚¯ï¼','è½ã¡ç€ãæ™‚é–“'];
        const idx = Math.floor((score - 70) / 5);
        const label = score >= 90 ? 'ğŸ”¥æœ€å¼·ã®ãƒ”ãƒ¼ã‚¯ï¼' : score >= 85 ? 'â­å¥½èª¿ï¼' : score >= 80 ? 'â†‘ä¸Šæ˜‡ä¸­' : 'â†’å®‰å®š';
        return { time: slot.time, score, label };
    }).sort((a,b) => b.score - a.score).slice(0, 4);
}

// ãƒ©ãƒƒã‚­ãƒ¼å ´æ‰€è¨ˆç®—
function calcLuckyPlaces(element, situation, now, score) {
    const isInMiyazaki = situation.includes('å®®å´');
    const db = isInMiyazaki ? luckyPlaceDB['å®®å´'] : luckyPlaceDB['default'];

    const elementToCategory = {
        'ç«': ['spiritual','nature','shopping','cafe'],
        'åœŸ': ['shopping','cafe','nature','spiritual'],
        'é¢¨': ['cafe','shopping','spiritual','nature'],
        'æ°´': ['nature','spiritual','cafe','shopping'],
    };
    const cats = elementToCategory[element] || ['spiritual','nature','shopping','cafe'];

    const directions = { spiritual:'åŒ—',nature:'æ±',shopping:'å—',cafe:'å—æ±' };
    const reasons = {
        spiritual: 'ç¥è–ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒé«˜ã¾ã‚Šã€é¡˜ã„ãŒå¶ã„ã‚„ã™ã„è–åœ°ã§ã™ã€‚',
        nature:    'è‡ªç„¶ã®ãƒ‘ãƒ¯ãƒ¼ãŒé‹æ°—ã‚’æµ„åŒ–ã—ã€æ–°ãŸãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ä¸ãˆã¦ãã‚Œã¾ã™ã€‚',
        shopping:  'é‡‘é‹ã¨äººã¨ã®ç¸ãŒçµã°ã‚Œã‚„ã™ã„ã€è³‘ã‚ã„ã®ã‚ã‚‹å ´æ‰€ã§ã™ã€‚',
        cafe:      'ã‚†ã£ãã‚Šã¨æµã‚Œã‚‹æ™‚é–“ã®ä¸­ã§ã€è‰¯ç¸ã¨å‡ºä¼šã„ã‚’å¼•ãå¯„ã›ã¾ã™ã€‚',
    };

    return cats.slice(0,3).map((cat, i) => {
        const spots = db[cat] || db['default'][cat];
        const spot = spots[now.getDate() % spots.length];
        return {
            rank: i+1,
            name: cat === 'spiritual' ? 'ç¥ç¤¾ãƒ»ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆ' : cat === 'nature' ? 'è‡ªç„¶ã‚¹ãƒãƒƒãƒˆ' : cat === 'shopping' ? 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢' : 'ã‚«ãƒ•ã‚§ãƒ»å–«èŒ¶åº—',
            category: cat === 'spiritual' ? 'â›©ï¸ ç¥ç¤¾ãƒ»è–åœ°' : cat === 'nature' ? 'ğŸŒ¿ è‡ªç„¶ãƒ»å…¬åœ’' : cat === 'shopping' ? 'ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°' : 'â˜• ã‚«ãƒ•ã‚§',
            nearby: spot,
            reason: reasons[cat],
            direction: directions[cat],
        };
    });
}

// ãƒ©ãƒƒã‚­ãƒ¼ãƒ•ãƒ¼ãƒ‰è¨ˆç®—
function calcLuckyFoods(element, zodiac, now, situation) {
    const foods = luckyFoodDB[element] || luckyFoodDB['æ°´'];
    const isInMiyazaki = situation.includes('å®®å´') || situation.includes('ã‚¤ã‚ªãƒ³');

    return foods.slice(0,3).map((f, i) => {
        let shop = f.shop;
        if (isInMiyazaki) {
            if (f.name.includes('ã„ã¡ã”')) shop = 'ãƒ‡ã‚£ãƒƒãƒ‘ãƒ¼ãƒ€ãƒ³ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å®®å´2Fï¼‰';
            else if (f.name.includes('ã†ã©ã‚“')) shop = 'ä¸¸äº€è£½éººï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å®®å´2Fï¼‰';
            else if (f.name.includes('å¯¿å¸')) shop = 'å›è»¢å¯¿å¸ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å®®å´å‘¨è¾ºï¼‰';
            else if (f.name.includes('ã‚³ãƒ¼ãƒ’ãƒ¼') || f.name.includes('ã‚«ãƒ•ã‚§')) shop = 'ãƒ‡ã‚£ãƒƒãƒ‘ãƒ¼ãƒ€ãƒ³ãƒ»ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹';
        }
        return { rank: i+1, name: f.name, color: f.color, shop, reason: `${element}ã®æ°—ã‚’æŒã¤ã‚ãªãŸã«æœ€é©ã€‚é‹æ°—ã¨ä½“ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒé«˜ã¾ã‚Šã¾ã™ã€‚`, best_time: f.time };
    });
}

// å è¡“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
function generateDivinationMessages(zodiac, blood, eto, rokuyo, kyusei, lp, dayKan, moonPhase, score, now) {
    const zData = zodiacBase[zodiac];
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

    return [
        {
            name: `ğŸŒŸ è¥¿æ´‹å æ˜Ÿè¡“ï¼ˆ${zodiac}ãƒ»${zData.planet}æ”¯é…ï¼‰`,
            text: `${zData.planet}ã®å½±éŸ¿ã§${score >= 88 ? 'å¼·åŠ›ãªå¹¸é‹ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæµã‚Œã¦ã„ã¾ã™ã€‚ç©æ¥µçš„ãªè¡Œå‹•ãŒå‰ã€‚' : score >= 82 ? 'å®‰å®šã—ãŸé‹æ°—ã®ä¸­ã€ç›´æ„Ÿã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã§å¥½æ©Ÿã‚’æ´ã‚ã¾ã™ã€‚' : 'æ…é‡ã•ã®ä¸­ã«ã‚‚å‰é€²ã™ã‚‹å‹‡æ°—ã‚’æŒã£ã¦ã€‚ãƒãƒ£ãƒ³ã‚¹ã¯å¿…ãšæ¥ã¾ã™ã€‚'}ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ã¯${zData.luckyColor}ã€‚`
        },
        {
            name: `ğŸ”¢ æ•°ç§˜è¡“ï¼ˆãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹${lp}ï¼‰`,
            text: `ã‚ãªãŸã®ãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹æ•°${lp}ã¯${lp <= 3 ? 'å‰µé€ ã¨è¡¨ç¾' : lp <= 6 ? 'æ„›ã¨å¥‰ä»•' : lp <= 9 ? 'æ™ºæ…§ã¨å®Œæˆ' : 'ç›´æ„Ÿã¨ãƒã‚¹ã‚¿ãƒ¼'}ã®æ•°ã€‚ä»Šæ—¥ã®æ•°å€¤${now.getDate()}ã¨ã®ç›¸æ€§ã¯${(now.getDate() + lp) % 2 === 0 ? 'â—æŠœç¾¤' : 'â—‹è‰¯å¥½'}ã§ã™ã€‚`
        },
        {
            name: `â­ ä¹æ˜Ÿæ°—å­¦ï¼ˆ${kyusei}ï¼‰`,
            text: `${kyusei}ã®æ–¹ã¯ä»Šæ—¥ã€${score >= 88 ? 'é‹å‘½çš„ãªå‡ºä¼šã„ã¨å¥½æ©ŸãŒé‡ãªã‚‹å¼·é‹ã®æ—¥ã€‚' : 'ç€å®Ÿãªå‰é€²ãŒå‰ã€‚'}${days[now.getDay()]}æ›œæ—¥ã®${kyusei}ã¯ç‰¹ã«${now.getDay() === 3 || now.getDay() === 5 ? 'å¯¾äººé‹ãŒé«˜ã¾ã‚Šã¾ã™' : 'æ´»å‹•é‹ãŒè‰¯å¥½ã§ã™'}ã€‚`
        },
        {
            name: `ğŸ“… å…­æ›œï¼ˆ${rokuyo}ï¼‰`,
            text: `æœ¬æ—¥ã¯${rokuyo}ã€‚${{ 'å¤§å®‰':'ä½•äº‹ã«ã‚‚æœ€è‰¯ã®æ—¥ã€‚æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹ã®ã«æœ€é©ã§ã™ã€‚', 'å‹å¼•':'å‹ã‚’å¼•ãå¯„ã›ã‚‹å‰æ—¥ã€‚äººã¨ã®ç¸ãŒæ·±ã¾ã‚Šã¾ã™ã€‚', 'å…ˆå‹':'åˆå‰ä¸­ãŒç‰¹ã«å‰ã€‚ç´ æ—©ã„è¡Œå‹•ãŒé–‹é‹ã®ã‚«ã‚®ã€‚', 'å…ˆè² ':'åˆå¾Œã‹ã‚‰é‹æ°—ä¸Šæ˜‡ã€‚ç„¦ã‚‰ãšå¾…ã¤ã“ã¨ãŒå‰ã€‚', 'èµ¤å£':'æ­£åˆã®ã¿å‰ã€‚æ…é‡ã«è¡Œå‹•ã—ã¾ã—ã‚‡ã†ã€‚', 'ä»æ»…':'å¤‰åŒ–ã¨è»¢æ›ã®æ—¥ã€‚æ–°ãŸãªå§‹ã¾ã‚Šã¸ã®æº–å‚™æœŸé–“ã€‚' }[rokuyo]}`
        },
        {
            name: `ğŸŒ™ æœˆç›¸ï¼ˆ${moonPhase.phase}${moonPhase.emoji}ï¼‰`,
            text: `${moonPhase.phase}ã®ä»Šæ—¥ã¯${{ 'æº€æœˆ':'ç›´æ„Ÿã¨æ„Ÿæƒ…ãŒæœ€é«˜æ½®ã€‚æ‹æ„›é‹ãƒ»å¯¾äººé‹ãŒç‰¹ã«å¼·ã¾ã‚Šã¾ã™ã€‚', 'æ–°æœˆ':'æ–°ã—ã„å§‹ã¾ã‚Šã«æœ€é©ã€‚é¡˜ã„äº‹ã‚’ã™ã‚‹ã®ã«çµ¶å¥½ã®æ—¥ã€‚', 'ä¸‰æ—¥æœˆ':'ç‰©äº‹ãŒã‚†ã£ãã‚Šã¨å‹•ãå§‹ã‚ã¾ã™ã€‚ç„¦ã‚‰ãšè‚²ã¦ã‚‹æ„è­˜ã§ã€‚', 'ä¸Šå¼¦ã®æœˆ':'è¡Œå‹•åŠ›ãŒé«˜ã¾ã‚Šã¾ã™ã€‚ç©æ¥µçš„ã«å‹•ãã“ã¨ã§é‹ãŒé–‹ã‘ã¾ã™ã€‚', 'åä¸‰å¤œ':'æˆæœãŒè¦‹ãˆå§‹ã‚ã‚‹æ™‚æœŸã€‚ã‚‚ã†ã²ã¨è¸ã‚“å¼µã‚ŠãŒå¤§åˆ‡ã€‚', 'ä¸‹å¼¦ã®æœˆ':'æ‰‹æ”¾ã—ã¨æ•´ç†ã®æ™‚ã€‚ä¸è¦ãªã‚‚ã®ã‚’æ–­æ¨é›¢ã™ã‚‹ã¨é‹æ°—UPã€‚', 'æ™¦æ—¥æœˆ':'é™ã‹ã«å†…çœã™ã‚‹æ™‚æœŸã€‚æ¬¡ã®æ–°æœˆã«å‘ã‘ã¦æº–å‚™ã‚’ã€‚' }[moonPhase.phase] || 'é™ã‹ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ä¸­ã§ã€è‡ªåˆ†ã‚’è¦‹ã¤ã‚ç›´ã™è‰¯ã„æ©Ÿä¼šã§ã™ã€‚'}`
        },
        {
            name: `ğŸ€„ å››æŸ±æ¨å‘½ï¼ˆæ—¥å¹²ï¼š${dayKan}ï¼‰`,
            text: `ä»Šæ—¥ã®æ—¥å¹²ã€Œ${dayKan}ã€ã¯ã‚ãªãŸã®å¹²æ”¯ã€Œ${document.getElementById('eto').value}ã€ã¨ã®ç›¸æ€§ãŒ${{ 'ç”²':'â—', 'ä¹™':'â—‹', 'ä¸™':'â—', 'ä¸':'â—‹', 'æˆŠ':'â–³', 'å·±':'â—‹', 'åºš':'â—', 'è¾›':'â—‹', 'å£¬':'â—', 'ç™¸':'â–³' }[dayKan]}ã€‚${{ 'ç”²':'åŠ›å¼·ã„æˆé•·ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼', 'ä¹™':'æŸ”è»Ÿã§é©å¿œåŠ›ã®ã‚ã‚‹', 'ä¸™':'æ˜ã‚‹ãæƒ…ç†±çš„ãª', 'ä¸':'ç¹Šç´°ã§æ„Ÿå—æ€§è±Šã‹ãª', 'æˆŠ':'å®‰å®šã¨å®Ÿç›´ãª', 'å·±':'ç´°ã‚„ã‹ã§ä¸å¯§ãª', 'åºš':'é‹­ãè¡Œå‹•åŠ›ã‚ã‚‹', 'è¾›':'æ´—ç·´ã•ã‚ŒãŸç¾ã—ã„', 'å£¬':'å¤§ããªæµã‚Œã‚’æŒã¤', 'ç™¸':'æ¸…ã‚‰ã‹ã§ç›´æ„Ÿçš„ãª' }[dayKan]}ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä»Šæ—¥ã‚’å½©ã‚Šã¾ã™ã€‚`
        },
        {
            name: `ğŸ©¸ è¡€æ¶²å‹å ã„ï¼ˆ${blood}å‹ï¼‰`,
            text: `${{ 'A':'å‡ å¸³é¢ã§èª å®ŸãªAå‹', 'B':'è‡ªç”±ã§å€‹æ€§çš„ãªBå‹', 'O':'å¤§ã‚‰ã‹ã§ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚ã‚‹Oå‹', 'AB':'äºŒé¢æ€§ã‚’æŒã¤æ„Ÿå—æ€§è±Šã‹ãªABå‹' }[blood]}ã®ä»Šæ—¥ã¯${{ 'A':'ä¸å¯§ãªè¡Œå‹•ãŒè©•ä¾¡ã•ã‚Œã‚‹æ—¥ã€‚', 'B':'ç›´æ„Ÿã‚’ä¿¡ã˜ã¦å‹•ãã¨å‰ã€‚', 'O':'å‘¨å›²ã¨ã®èª¿å’ŒãŒé‹æ°—ã‚’é«˜ã‚ã‚‹ã€‚', 'AB':'ä¸¡é¢ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚ŒãŸæœ€è‰¯ã®æ—¥ã€‚' }[blood]}ç‰¹ã«${score >= 88 ? 'åˆå¾Œã‹ã‚‰å¤•æ–¹ã«ã‹ã‘ã¦é‹æ°—ãŒæœ€é«˜æ½®ã«é”ã—ã¾ã™ã€‚' : 'æœã®è¡Œå‹•ãŒä¸€æ—¥ã®é‹æ°—ã‚’æ±ºã‚ã¾ã™ã€‚'}`
        },
    ];
}

// ç·åˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”Ÿæˆ
function generateOverallMessage(zodiac, rokuyo, score, now, situation) {
    const days = ['æ—¥æ›œæ—¥','æœˆæ›œæ—¥','ç«æ›œæ—¥','æ°´æ›œæ—¥','æœ¨æ›œæ—¥','é‡‘æ›œæ—¥','åœŸæ›œæ—¥'];
    const msgs = [
        `${days[now.getDay()]}ã®${zodiac}ã¯é‹æ°—${score}ç‚¹ã€‚${rokuyo}ã¨é‡ãªã‚Šã€${score >= 88 ? 'ç‰¹åˆ¥ãªå‡ºä¼šã„ã¨å¹¸é‹ãŒè¨ªã‚Œã‚‹æœ€é«˜ã®ä¸€æ—¥ã§ã™ã€‚ç©æ¥µçš„ãªè¡Œå‹•ãŒã‚ãªãŸã®é‹å‘½ã‚’å¤‰ãˆã¾ã™ã€‚' : score >= 82 ? 'ç€å®Ÿãªå‰é€²ã¨è‰¯ç¸ã«æµã¾ã‚Œã‚‹æ—¥ã§ã™ã€‚ç¬‘é¡”ã‚’å¿˜ã‚Œãšã«ã€‚' : 'ç©ã‚„ã‹ãªé‹æ°—ã®ä¸­ã«ç¢ºã‹ãªãƒãƒ£ãƒ³ã‚¹ãŒæ½œã‚“ã§ã„ã¾ã™ã€‚'}`,
        `${situation ? situation + 'ã«ã„ã‚‹ä»Šã€' : ''}å®‡å®™ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒã‚ãªãŸã«å¾®ç¬‘ã‚“ã§ã„ã¾ã™ã€‚${score >= 88 ? 'é‹å‘½çš„ãªå‡ºä¼šã„ã®äºˆæ„Ÿå¤§ã€‚' : 'è‰¯ã„ã“ã¨ãŒèµ·ã“ã‚‹äºˆæ„Ÿã‚’å¤§åˆ‡ã«ã€‚'}ä»Šæ—¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œ${score >= 88 ? 'ç¸ãƒ»å‡ºä¼šã„ãƒ»å¥‡è·¡' : score >= 82 ? 'å‰é€²ãƒ»æˆé•·ãƒ»ç¬‘é¡”' : 'æº–å‚™ãƒ»å†…çœãƒ»æ„Ÿè¬'}ã€ã§ã™ã€‚`,
    ];
    return msgs[now.getDate() % msgs.length];
}

// ========== å ã„å®Ÿè¡Œ ==========
function startFortune() {
    const zodiac = document.getElementById('zodiac').value;
    const blood = document.getElementById('blood-type').value;
    const eto = document.getElementById('eto').value;
    const birthdate = document.getElementById('birthdate').value || '1993-04-14';
    const situation = document.getElementById('situation').value || currentLocation || 'å®®å´å¸‚';
    const now = new Date();

    document.getElementById('loading').classList.add('show');
    document.getElementById('result').classList.remove('show');

    // å°‘ã—é–“ã‚’ç½®ã„ã¦ãƒªã‚¢ãƒ«æ„Ÿã‚’æ¼”å‡º
    setTimeout(() => {
        const data = calculateFortune(zodiac, blood, eto, birthdate, situation, now);
        displayResult(data, now, situation);
        document.getElementById('loading').classList.remove('show');
    }, 1800);
}

// ========== çµæœè¡¨ç¤º ==========
function displayResult(data, now, location) {
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    const m = now.getMonth()+1, d = now.getDate();
    const h = String(now.getHours()).padStart(2,'0');
    const min = String(now.getMinutes()).padStart(2,'0');
    const dateStr = `${m}/${d}(${days[now.getDay()]}) ${h}:${min}`;

    const resultDiv = document.getElementById('result');

    let html = `
    <div class="result-card card-overall">
        <div class="card-header">
            <div class="card-icon">ğŸŒŸ</div>
            <div>
                <div class="card-title">ä»Šæ—¥ã®ç·åˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                <div class="card-subtitle">${dateStr} | ${location} | ${data.rokuyo} ${data.moonPhase.emoji}</div>
            </div>
        </div>
        <div class="overall-msg">${data.overall}</div>
    </div>

    <div class="result-card card-time">
        <div class="card-header">
            <div class="card-icon">â°</div>
            <div>
                <div class="card-title">ãƒ©ãƒƒã‚­ãƒ¼ã‚¿ã‚¤ãƒ </div>
                <div class="card-subtitle">ä¹æ˜Ÿæ°—å­¦ãƒ»æ•°ç§˜è¡“ãƒ»æ˜Ÿåº§ã‚’çµ±åˆã—ã¦ç®—å‡º</div>
            </div>
        </div>
        <div class="time-grid">
            ${data.luckyTimes.map(t => `
            <div class="time-item">
                <div class="time-range">${t.time}</div>
                <div class="time-score-val" style="color:${t.score>=90?'#FFD700':t.score>=85?'#C9A84C':'#9A8AB0'}">${t.score}ç‚¹</div>
                <div class="time-label">${t.label}</div>
            </div>`).join('')}
        </div>
    </div>

    <div class="result-card card-place">
        <div class="card-header">
            <div class="card-icon">ğŸ“</div>
            <div>
                <div class="card-title">ãƒ©ãƒƒã‚­ãƒ¼ã‚¹ãƒãƒƒãƒˆ</div>
                <div class="card-subtitle">é¢¨æ°´ãƒ»ä¹æ˜Ÿæ°—å­¦ã«åŸºã¥ãé–‹é‹ã®å ´æ‰€</div>
            </div>
        </div>
        ${data.places.map(p => `
        <div class="place-item">
            <div class="place-rank">ğŸ† ç¬¬${p.rank}ä½ | ${p.category} | ${p.direction}ã®æ–¹è§’ãŒå‰</div>
            <div class="place-name">${p.name}</div>
            <div class="place-nearby">ğŸ“ è¿‘ãï¼š${p.nearby}</div>
            <div class="place-reason">${p.reason}</div>
        </div>`).join('')}
    </div>

    <div class="result-card card-food">
        <div class="card-header">
            <div class="card-icon">ğŸ½ï¸</div>
            <div>
                <div class="card-title">ãƒ©ãƒƒã‚­ãƒ¼ãƒ•ãƒ¼ãƒ‰</div>
                <div class="card-subtitle">äº”è¡Œèª¬ãƒ»æ˜Ÿåº§ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã«åŸºã¥ãé–‹é‹é£Ÿ</div>
            </div>
        </div>
        ${data.foods.map(f => `
        <div class="food-item">
            <div class="food-rank">ğŸ€ ç¬¬${f.rank}ä½ | ${f.color}ã®é£Ÿã¹ç‰© | ${f.best_time}</div>
            <div class="food-name">${f.name}</div>
            <div class="food-shop">ğŸª ${f.shop}</div>
            <div class="food-reason">${f.reason}</div>
        </div>`).join('')}
    </div>

    <div class="result-card card-divination">
        <div class="card-header">
            <div class="card-icon">ğŸ”®</div>
            <div>
                <div class="card-title">å è¡“åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                <div class="card-subtitle">7ç¨®é¡ã®å è¡“ã‚’çµ±åˆ</div>
            </div>
        </div>
        ${data.divinations.map(d => `
        <div class="div-item">
            <div class="div-name">${d.name}</div>
            <div class="div-text">${d.text}</div>
        </div>`).join('')}
    </div>`;

    resultDiv.innerHTML = html;
    resultDiv.classList.add('show');
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// åˆæœŸè¨­å®š
document.getElementById('zodiac').value = 'ç‰¡ç¾Šåº§';
</script>
</body>
</html>
