<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”® Lucky Compass - é–‹é‹ãƒŠãƒ“</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700;900&family=Zen+Old+Mincho:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #C9A84C;
            --gold-light: #F0D080;
            --deep: #0A0614;
            --purple: #1A0A2E;
            --violet: #2D1B5E;
            --accent: #8B5CF6;
            --rose: #FF6B9D;
            --text: #F0E6FF;
            --muted: #9A8AB0;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Serif JP', serif;
            background: var(--deep);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .starfield { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
        .star {
            position: absolute; border-radius: 50%; background: white;
            animation: twinkle var(--dur,3s) infinite var(--delay,0s);
        }
        @keyframes twinkle {
            0%,100%{opacity:.2;transform:scale(1)} 50%{opacity:1;transform:scale(1.5)}
        }
        .shooting-star {
            position: absolute; width: 120px; height: 1px;
            background: linear-gradient(90deg, transparent, white, transparent);
            animation: shoot 6s linear infinite; opacity: 0;
        }
        @keyframes shoot {
            0%{transform:translateX(-200px) translateY(0) rotate(-30deg);opacity:0}
            10%{opacity:1} 90%{opacity:1}
            100%{transform:translateX(calc(100vw + 200px)) translateY(200px) rotate(-30deg);opacity:0}
        }
        .container { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding: 20px; }
        header { text-align: center; padding: 40px 0 30px; }
        .header-symbol { font-size: 3.5rem; display: block; margin-bottom: 10px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
        h1 {
            font-family: 'Zen Old Mincho', serif; font-size: 2rem; font-weight: 900;
            background: linear-gradient(135deg, var(--gold), var(--gold-light), var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; letter-spacing: .1em; margin-bottom: 8px;
        }
        .subtitle { font-size: .8rem; color: var(--muted); letter-spacing: .15em; }
        .info-bar { display: flex; gap: 10px; margin: 20px 0; }
        .info-chip {
            flex: 1; background: rgba(255,255,255,.04);
            border: 1px solid rgba(201,168,76,.2); border-radius: 12px; padding: 12px; text-align: center;
        }
        .info-chip .label { color: var(--gold); font-size: .65rem; letter-spacing: .1em; margin-bottom: 4px; }
        .info-chip .value { color: var(--text); font-weight: 700; font-size: .8rem; }
        .location-btn {
            width: 100%; padding: 14px;
            background: rgba(201,168,76,.1); border: 1px solid rgba(201,168,76,.3);
            border-radius: 12px; color: var(--gold); font-size: .85rem;
            font-family: 'Noto Serif JP', serif; cursor: pointer; margin-bottom: 12px; transition: all .2s;
        }
        .location-btn:hover { background: rgba(201,168,76,.2); }
        .location-btn.success { border-color: rgba(100,255,150,.4); color: #80FFB0; background: rgba(100,255,150,.05); }
        .settings-card {
            background: rgba(255,255,255,.03); border: 1px solid rgba(201,168,76,.15);
            border-radius: 20px; padding: 25px; margin: 15px 0;
        }
        .settings-title { font-size: .75rem; color: var(--gold); letter-spacing: .15em; margin-bottom: 20px; text-align: center; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: 1 / -1; }
        label { font-size: .7rem; color: var(--muted); letter-spacing: .1em; }
        select, input {
            background: rgba(255,255,255,.06); border: 1px solid rgba(201,168,76,.2);
            border-radius: 10px; color: var(--text); padding: 10px 12px; font-size: .8rem;
            font-family: 'Noto Serif JP', serif; width: 100%; appearance: none;
        }
        select:focus, input:focus { outline: none; border-color: var(--gold); }
        option { background: #1A0A2E; }
        .fortune-btn {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, #7C3AED, #C9A84C, #7C3AED);
            background-size: 200% 200%; border: none; border-radius: 16px; color: white;
            font-size: 1rem; font-family: 'Zen Old Mincho', serif; font-weight: 700;
            letter-spacing: .1em; cursor: pointer; margin: 20px 0;
            animation: gradientShift 3s ease infinite; position: relative; overflow: hidden;
        }
        @keyframes gradientShift {
            0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%}
        }
        .fortune-btn:active { transform: scale(.98); }
        .loading { display: none; text-align: center; padding: 50px 0; }
        .loading.show { display: block; }
        .crystal-ball { font-size: 4rem; animation: pulse 1s ease-in-out infinite; display: block; margin-bottom: 20px; }
        @keyframes pulse { 0%,100%{transform:scale(1);filter:brightness(1)} 50%{transform:scale(1.1);filter:brightness(1.3)} }
        .loading-text { color: var(--gold); font-size: .9rem; letter-spacing: .2em; animation: fade 1.5s ease-in-out infinite; }
        @keyframes fade { 0%,100%{opacity:.5} 50%{opacity:1} }
        .result { display: none; animation: fadeInUp .8s ease-out; }
        .result.show { display: block; }
        @keyframes fadeInUp { from{opacity:0;transform:translateY(30px)} to{opacity:1;transform:translateY(0)} }
        .result-card {
            border-radius: 20px; padding: 25px; margin: 15px 0;
            position: relative; overflow: hidden;
        }
        .result-card::before {
            content: ''; position: absolute; inset: 0; border-radius: 20px; padding: 1px;
            background: linear-gradient(135deg, var(--gold), transparent, var(--accent));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
        }
        .card-overall { background: linear-gradient(135deg, rgba(201,168,76,.1), rgba(10,6,20,.8)); }
        .card-time { background: linear-gradient(135deg, rgba(201,168,76,.08), rgba(10,6,20,.8)); }
        .card-place { background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(10,6,20,.8)); }
        .card-food { background: linear-gradient(135deg, rgba(255,107,157,.1), rgba(10,6,20,.8)); }
        .card-divination { background: linear-gradient(135deg, rgba(45,27,94,.5), rgba(10,6,20,.8)); }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 18px; }
        .card-icon {
            font-size: 1.8rem; width: 50px; height: 50px; display: flex;
            align-items: center; justify-content: center;
            background: rgba(255,255,255,.05); border-radius: 12px;
        }
        .card-title { font-family: 'Zen Old Mincho', serif; font-size: 1rem; color: var(--gold); letter-spacing: .1em; }
        .card-subtitle { font-size: .7rem; color: var(--muted); margin-top: 2px; }
        .overall-msg { font-size: .9rem; line-height: 1.8; color: var(--text); }
        .time-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .time-item { background: rgba(255,255,255,.04); border-radius: 12px; padding: 12px; text-align: center; }
        .time-range { font-size: .9rem; font-weight: 700; color: var(--gold); margin-bottom: 4px; }
        .time-score-val { font-size: 1.3rem; font-weight: 900; margin: 5px 0; }
        .time-label { font-size: .7rem; color: var(--muted); }
        .place-item {
            background: rgba(255,255,255,.04); border-radius: 14px; padding: 15px;
            margin-bottom: 10px; border-left: 3px solid var(--accent);
        }
        .place-rank { font-size: .65rem; color: var(--accent); letter-spacing: .1em; margin-bottom: 5px; }
        .place-name { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .place-nearby { font-size: .8rem; color: var(--gold); margin-bottom: 4px; }
        .place-reason { font-size: .75rem; color: var(--muted); line-height: 1.6; }
        .food-item {
            background: rgba(255,255,255,.04); border-radius: 14px; padding: 15px;
            margin-bottom: 10px; border-left: 3px solid var(--rose);
        }
        .food-rank { font-size: .65rem; color: var(--rose); letter-spacing: .1em; margin-bottom: 5px; }
        .food-name { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
        .food-shop { font-size: .8rem; color: var(--gold); margin-bottom: 4px; }
        .food-reason { font-size: .75rem; color: var(--muted); line-height: 1.6; }
        .div-item { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,.05); }
        .div-item:last-child { border-bottom: none; }
        .div-name { font-size: .7rem; color: var(--gold); letter-spacing: .1em; margin-bottom: 5px; }
        .div-text { font-size: .8rem; color: var(--text); line-height: 1.7; }
        .error-msg {
            background: rgba(255,100,100,.1); border: 1px solid rgba(255,100,100,.3);
            border-radius: 12px; padding: 15px; text-align: center;
            color: #FF8080; font-size: .85rem; margin: 15px 0; display: none;
        }
        .error-msg.show { display: block; }
        footer { text-align: center; padding: 30px 0; color: var(--muted); font-size: .7rem; letter-spacing: .1em; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--deep); }
        ::-webkit-scrollbar-thumb { background: var(--violet); border-radius: 4px; }
    </style>
</head>
<body>
<div class="starfield" id="starfield"></div>
<div class="container">
    <header>
        <span class="header-symbol">ğŸ”®</span>
        <h1>Lucky Compass</h1>
        <p class="subtitle">é–‹é‹ãƒŠãƒ“ â”€ å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ </p>
    </header>

    <div class="info-bar">
        <div class="info-chip">
            <div class="label">ğŸ“… æ—¥æ™‚</div>
            <div class="value" id="datetime-display">å–å¾—ä¸­...</div>
        </div>
        <div class="info-chip">
            <div class="label">ğŸ“ ä½ç½®</div>
            <div class="value" id="location-display">æœªå–å¾—</div>
        </div>
    </div>

    <button class="location-btn" id="location-btn" onclick="getLocation()">
        ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹
    </button>

    <div class="error-msg" id="error-msg"></div>

    <div class="settings-card">
        <div class="settings-title">âœ¦ ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ› âœ¦</div>
        <div class="form-row">
            <div class="form-group">
                <label>æ˜Ÿåº§</label>
                <select id="zodiac">
                    <option value="ç‰¡ç¾Šåº§">ç‰¡ç¾Šåº§ â™ˆ</option>
                    <option value="ç‰¡ç‰›åº§">ç‰¡ç‰›åº§ â™‰</option>
                    <option value="åŒå­åº§">åŒå­åº§ â™Š</option>
                    <option value="èŸ¹åº§">èŸ¹åº§ â™‹</option>
                    <option value="ç…å­åº§">ç…å­åº§ â™Œ</option>
                    <option value="ä¹™å¥³åº§">ä¹™å¥³åº§ â™</option>
                    <option value="å¤©ç§¤åº§">å¤©ç§¤åº§ â™</option>
                    <option value="è åº§">è åº§ â™</option>
                    <option value="å°„æ‰‹åº§">å°„æ‰‹åº§ â™</option>
                    <option value="å±±ç¾Šåº§">å±±ç¾Šåº§ â™‘</option>
                    <option value="æ°´ç“¶åº§">æ°´ç“¶åº§ â™’</option>
                    <option value="é­šåº§">é­šåº§ â™“</option>
                </select>
            </div>
            <div class="form-group">
                <label>è¡€æ¶²å‹</label>
                <select id="blood-type">
                    <option value="A">Aå‹</option>
                    <option value="B" selected>Bå‹</option>
                    <option value="O">Oå‹</option>
                    <option value="AB">ABå‹</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>å¹²æ”¯</label>
                <select id="eto">
                    <option value="å­">å­ï¼ˆã­ãšã¿ï¼‰</option>
                    <option value="ä¸‘">ä¸‘ï¼ˆã†ã—ï¼‰</option>
                    <option value="å¯…">å¯…ï¼ˆã¨ã‚‰ï¼‰</option>
                    <option value="å¯">å¯ï¼ˆã†ã•ãï¼‰</option>
                    <option value="è¾°">è¾°ï¼ˆãŸã¤ï¼‰</option>
                    <option value="å·³">å·³ï¼ˆã¸ã³ï¼‰</option>
                    <option value="åˆ">åˆï¼ˆã†ã¾ï¼‰</option>
                    <option value="æœª">æœªï¼ˆã²ã¤ã˜ï¼‰</option>
                    <option value="ç”³">ç”³ï¼ˆã•ã‚‹ï¼‰</option>
                    <option value="é…‰" selected>é…‰ï¼ˆã¨ã‚Šï¼‰</option>
                    <option value="æˆŒ">æˆŒï¼ˆã„ã¬ï¼‰</option>
                    <option value="äº¥">äº¥ï¼ˆã„ã®ã—ã—ï¼‰</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç”Ÿå¹´æœˆæ—¥</label>
                <input type="date" id="birthdate" value="1993-04-14">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group full">
                <label>ç¾åœ¨ã®å ´æ‰€ãƒ»çŠ¶æ³ï¼ˆä»»æ„ï¼‰</label>
                <input type="text" id="situation" placeholder="ä¾‹ï¼šå®®å´å¸‚ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«ã€è‡ªå®…ã€å¤–å‡ºä¸­">
            </div>
        </div>
    </div>

    <button class="fortune-btn" onclick="startFortune()">
        âœ¨ ä»Šã“ã®å ´æ‰€ã®é‹å‹¢ã‚’å ã† âœ¨
    </button>

    <div class="loading" id="loading">
        <span class="crystal-ball">ğŸ”®</span>
        <div class="loading-text">æ˜Ÿã€…ã«å•ã„ã‹ã‘ã¦ã„ã¾ã™...</div>
    </div>

    <div class="result" id="result"></div>

    <footer>
        Powered by ã‚¯ãƒˆã¡ã‚ƒã‚“ ğŸ’« å…¨å è¡“çµ±åˆã‚·ã‚¹ãƒ†ãƒ <br>
        è¥¿æ´‹å æ˜Ÿè¡“ãƒ»å››æŸ±æ¨å‘½ãƒ»ä¹æ˜Ÿæ°—å­¦ãƒ»é¢¨æ°´ãƒ»ã‚¿ãƒ­ãƒƒãƒˆãƒ»æ•°ç§˜è¡“çµ±åˆ
    </footer>
</div>

<script>
// ========== æ˜Ÿç©ºç”Ÿæˆ ==========
const sf = document.getElementById('starfield');
for (let i = 0; i < 120; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random() * 2 + .5;
    s.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${Math.random()*3+2}s;--delay:${Math.random()*3}s;`;
    sf.appendChild(s);
}
for (let i = 0; i < 3; i++) {
    const ss = document.createElement('div');
    ss.className = 'shooting-star';
    ss.style.cssText = `top:${Math.random()*40}%;left:0;animation-delay:${i*4+Math.random()*4}s;animation-duration:${5+Math.random()*3}s;`;
    sf.appendChild(ss);
}

// ========== æ—¥æ™‚æ›´æ–° ==========
function updateDatetime() {
    const now = new Date();
    const m = now.getMonth()+1, d = now.getDate();
    const h = String(now.getHours()).padStart(2,'0');
    const min = String(now.getMinutes()).padStart(2,'0');
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    document.getElementById('datetime-display').textContent = `${m}/${d}(${days[now.getDay()]}) ${h}:${min}`;
}
updateDatetime();
setInterval(updateDatetime, 1000);

// ========== ä½ç½®æƒ…å ± ==========
let currentCoords = null;
let currentLocation = '';

function getLocation() {
    const btn = document.getElementById('location-btn');
    btn.textContent = 'ğŸ“ å–å¾—ä¸­...';
    btn.disabled = true;

    if (!navigator.geolocation) {
        showError('ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        btn.textContent = 'ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹';
        btn.disabled = false;
        return;
    }

    navigator.geolocation.getCurrentPosition(
        async pos => {
            currentCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentCoords.lat}&lon=${currentCoords.lon}&format=json&accept-language=ja`);
                const data = await res.json();
                const a = data.address;
                currentLocation = (a.city||a.town||a.village||a.county||'') + (a.suburb||a.neighbourhood||'');
                if (!currentLocation) currentLocation = `ç·¯åº¦${currentCoords.lat.toFixed(2)}`;
            } catch {
                currentLocation = `ç·¯åº¦${currentCoords.lat.toFixed(2)} çµŒåº¦${currentCoords.lon.toFixed(2)}`;
            }
            document.getElementById('location-display').textContent = currentLocation;
            document.getElementById('situation').value = currentLocation;
            btn.textContent = `âœ… ${currentLocation}`;
            btn.className = 'location-btn success';
            btn.disabled = false;
        },
        err => {
            showError('ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            btn.textContent = 'ğŸ“ ä½ç½®æƒ…å ±ã‚’å–å¾—ã™ã‚‹';
            btn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
    );
}

function showError(msg) {
    const el = document.getElementById('error-msg');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 5000);
}

// ========== å…¨å è¡“è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³ ==========

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FIX 1: ä¹æ˜Ÿæ°—å­¦ï¼ˆæœ¬å‘½æ˜Ÿï¼‰- æ­£ã—ã„è¨ˆç®—å¼
// ç”Ÿå¹´ã®å„æ¡ã®å’ŒãŒ1æ¡ã«ãªã‚‹ã¾ã§åŠ ç®—ã—ã€11ã‹ã‚‰å¼•ã
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function getKyusei(birthYear) {
    let sum = String(birthYear).split('').map(Number).reduce((a, b) => a + b, 0);
    while (sum >= 10) {
        sum = String(sum).split('').map(Number).reduce((a, b) => a + b, 0);
    }
    let num = 11 - sum;
    if (num <= 0) num += 9;
    if (num > 9) num -= 9;
    const stars = ['', 'ä¸€ç™½æ°´æ˜Ÿ', 'äºŒé»’åœŸæ˜Ÿ', 'ä¸‰ç¢§æœ¨æ˜Ÿ', 'å››ç·‘æœ¨æ˜Ÿ', 'äº”é»„åœŸæ˜Ÿ', 'å…­ç™½é‡‘æ˜Ÿ', 'ä¸ƒèµ¤é‡‘æ˜Ÿ', 'å…«ç™½åœŸæ˜Ÿ', 'ä¹ç´«ç«æ˜Ÿ'];
    return stars[num];
    // ä¾‹: 1993å¹´ â†’ 1+9+9+3=22 â†’ 2+2=4 â†’ 11-4=7 â†’ ä¸ƒèµ¤é‡‘æ˜Ÿ
}

// æ•°ç§˜è¡“ï¼šãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹
function getLifePath(birthdate) {
    const digits = birthdate.replace(/-/g,'').split('').map(Number);
    let sum = digits.reduce((a,b)=>a+b,0);
    while (sum > 9 && sum !== 11 && sum !== 22) {
        sum = String(sum).split('').map(Number).reduce((a,b)=>a+b,0);
    }
    return sum;
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FIX 2: å››æŸ±æ¨å‘½ï¼ˆæ—¥å¹²ï¼‰- åŸºæº–æ—¥ä¿®æ­£
// 2026/2/20 = ä¹™ï¼ˆindex 1ï¼‰ã‚’åŸºæº–ã«è¨ˆç®—
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function getDayKan(now) {
    const base = new Date(2026, 1, 20); // 2026/2/20 = ä¹™
    const baseIndex = 1; // ä¹™
    const diff = Math.floor((now - base) / 86400000);
    const kans = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±','åºš','è¾›','å£¬','ç™¸'];
    return kans[((diff + baseIndex) % 10 + 10) % 10];
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FIX 3: å…­æ›œ - æ—§æš¦ï¼ˆæœˆ+æ—¥ï¼‰%6 ã«ã‚ˆã‚‹æ­£ã—ã„è¨ˆç®—
// åŸºæº–: 2026/2/17 = æ—§æš¦ä¸™åˆå¹´ æ­£æœˆ1æ—¥ï¼ˆæ˜¥ç¯€ï¼‰
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
function getLunarDate(date) {
    // 2026/2/17 = æ—§æš¦æ­£æœˆ1æ—¥ï¼ˆä¸™åˆå¹´ æ˜¥ç¯€ï¼‰ã‚’åŸºæº–ã¨ã™ã‚‹
    const REF = new Date(2026, 1, 17);
    // æ—§æš¦å„æœˆã®æ—¥æ•°æ¦‚ç®—ï¼ˆå¤§æœˆ30æ—¥ãƒ»å°æœˆ29æ—¥äº¤äº’ï¼‰
    const MONTH_DAYS = [30, 29, 30, 30, 29, 30, 29, 30, 29, 30, 30, 29];
    const diff = Math.round((date - REF) / 86400000);
    let m = 1, d = 1 + diff;
    if (d >= 1) {
        while (true) {
            const len = MONTH_DAYS[(m - 1) % 12];
            if (d <= len) break;
            d -= len; m++;
        }
    } else {
        while (d <= 0) {
            m--;
            if (m <= 0) m += 12;
            d += MONTH_DAYS[(m - 1) % 12];
        }
    }
    return [m, d];
    // ä¾‹: 2/20 â†’ diff=3 â†’ æ—§æš¦æ­£æœˆ4æ—¥ â†’ (1+4)%6=5 â†’ ä»æ»…
}

function getRokuyo(now) {
    const [lm, ld] = getLunarDate(now);
    const idx = (lm + ld) % 6;
    return ['å¤§å®‰','èµ¤å£','å…ˆå‹','å‹å¼•','å…ˆè² ','ä»æ»…'][idx];
}

// æ˜Ÿåº§åˆ¥åŸºæœ¬é‹æ°—
const zodiacBase = {
    'ç‰¡ç¾Šåº§':{base:88,element:'ç«',planet:'ç«æ˜Ÿ',luckyColor:'èµ¤',luckyNum:9},
    'ç‰¡ç‰›åº§':{base:82,element:'åœŸ',planet:'é‡‘æ˜Ÿ',luckyColor:'ç·‘',luckyNum:6},
    'åŒå­åº§':{base:86,element:'é¢¨',planet:'æ°´æ˜Ÿ',luckyColor:'é»„',luckyNum:5},
    'èŸ¹åº§'  :{base:80,element:'æ°´',planet:'æœˆ',luckyColor:'ç™½',luckyNum:2},
    'ç…å­åº§':{base:90,element:'ç«',planet:'å¤ªé™½',luckyColor:'é‡‘',luckyNum:1},
    'ä¹™å¥³åº§':{base:84,element:'åœŸ',planet:'æ°´æ˜Ÿ',luckyColor:'èŒ¶',luckyNum:5},
    'å¤©ç§¤åº§':{base:85,element:'é¢¨',planet:'é‡‘æ˜Ÿ',luckyColor:'ãƒ”ãƒ³ã‚¯',luckyNum:6},
    'è åº§'  :{base:87,element:'æ°´',planet:'å†¥ç‹æ˜Ÿ',luckyColor:'é»’',luckyNum:8},
    'å°„æ‰‹åº§':{base:89,element:'ç«',planet:'æœ¨æ˜Ÿ',luckyColor:'ç´«',luckyNum:3},
    'å±±ç¾Šåº§':{base:83,element:'åœŸ',planet:'åœŸæ˜Ÿ',luckyColor:'é»’',luckyNum:8},
    'æ°´ç“¶åº§':{base:86,element:'é¢¨',planet:'å¤©ç‹æ˜Ÿ',luckyColor:'é’',luckyNum:4},
    'é­šåº§'  :{base:81,element:'æ°´',planet:'æµ·ç‹æ˜Ÿ',luckyColor:'æ°´è‰²',luckyNum:7}
};

// è¡€æ¶²å‹è£œæ­£
const bloodBonus = { 'A':3, 'B':5, 'O':4, 'AB':6 };

// å¹²æ”¯è£œæ­£
const etoBonus = {
    'å­':4,'ä¸‘':3,'å¯…':6,'å¯':5,'è¾°':7,'å·³':4,'åˆ':6,'æœª':3,'ç”³':5,'é…‰':6,'æˆŒ':4,'äº¥':5
};

// æ›œæ—¥åˆ¥é‹æ°—
const dayBonus = [3,5,4,7,6,8,7];

// æ™‚é–“å¸¯åˆ¥é‹æ°—
function getHourScore(h) {
    const scores = [3,2,2,2,2,4,6,7,7,7,8,8,9,9,8,8,7,9,9,9,8,8,7,5];
    return scores[h] || 7;
}

// ========== ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å®®å´ é£²é£Ÿåº—ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ==========
const aeonMiyazakiRestaurants = {
    restaurant1F: [
        { name:'åŒ—æµ·é“ã‚­ãƒƒãƒãƒ³ YOSHIMI',    genre:'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³',    element:'åœŸ', color:'èŒ¶', time:'æ˜¼ã€œå¤•é£Ÿ', desc:'åŒ—æµ·é“ã®é£Ÿæã‚’ä½¿ã£ãŸãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã€‚ãƒ­ãƒ¼ã‚¹ãƒˆãƒ“ãƒ¼ãƒ•ä¸¼ãŒäººæ°—' },
        { name:'ã‚³ãƒ¡ãƒ€çˆç²åº—',              genre:'ã‚«ãƒ•ã‚§',        element:'é¢¨', color:'èŒ¶', time:'æœã€œå¤œ', desc:'åå¤å±‹ã®è€èˆ—ã‚«ãƒ•ã‚§ã€‚ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ã‚‚å……å®Ÿ' },
        { name:'ç¯‰åœ°é£Ÿå ‚ æºã¡ã‚ƒã‚“',         genre:'æµ·é®®ãƒ»å’Œé£Ÿ',    element:'æ°´', color:'ç™½', time:'æ˜¼ã€œå¤•é£Ÿ', desc:'ç†Ÿç·´ã®æ¿å‰ãŒèª¿ç†ã™ã‚‹å’Œé£Ÿãƒ»æµ·é®®ã€‚é¯›ã”ã¾ä¸¼ãŒäººæ°—' },
        { name:'ã¦ã‚“ã·ã‚‰ä¸€ä»£',              genre:'å¤©ã·ã‚‰',        element:'ç«', color:'é»„', time:'æ˜¼ã€œå¤•é£Ÿ', desc:'å®®å´çœŒåˆå‡ºåº—ã€‚ãƒªãƒ¼ã‚ºãƒŠãƒ–ãƒ«ãªæšã’ãŸã¦å¤©ã·ã‚‰' },
        { name:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ ã‚³ãƒ¼ãƒ’ãƒ¼ï¼ˆ1Fï¼‰', genre:'ã‚«ãƒ•ã‚§',    element:'é¢¨', color:'ç·‘', time:'æœã€œå¤œ', desc:'1Fã®ã‚¹ã‚¿ãƒã€‚ã‚†ã£ãã‚Šã§ãã‚‹ç©ºé–“' },
        { name:'ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒˆãƒãƒˆ',          genre:'ã‚«ãƒ•ã‚§ãƒ»æ´‹é£Ÿ',  element:'é¢¨', color:'èµ¤', time:'æ˜¼ã€œå¤•é£Ÿ', desc:'ãƒ‘ã‚¹ã‚¿ã‚„ãƒ©ãƒ³ãƒã‚»ãƒƒãƒˆãŒäººæ°—' },
        { name:'ã‚±ãƒ³ã‚¿ãƒƒã‚­ãƒ¼ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³', genre:'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', element:'ç«', color:'èµ¤', time:'æ˜¼ã€œå¤œ', desc:'å®šç•ªã®KFCã€‚å’Œé¢¨ãƒã‚­ãƒ³ã‚«ãƒ„ã‚µãƒ³ãƒ‰ãŒäººæ°—' },
        { name:'ãƒã‚¯ãƒ‰ãƒŠãƒ«ãƒ‰',              genre:'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', element:'ç«', color:'é»„', time:'æœã€œæ·±å¤œ', desc:'å®šç•ªã®ãƒãƒƒã‚¯ã€‚24æ™‚é–“å–¶æ¥­' },
        { name:'éŠ€åº§æƒ£èœåº—',               genre:'æƒ£èœãƒ»ç„¼ãé³¥',  element:'ç«', color:'èŒ¶', time:'æ˜¼ã€œå¤œ', desc:'ç„¼ãé³¥ãƒ»æƒ£èœã€‚ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆäººæ°—' },
        { name:'æŸ¿å®‰ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°',            genre:'æƒ£èœ',          element:'åœŸ', color:'èŒ¶', time:'æ˜¼ã€œå¤œ', desc:'ä¸Šè³ªãªæƒ£èœã€‚ãŠå¼å½“ã‚‚äººæ°—' },
    ],
    foodCourt2F: [
        { name:'ä¸¸äº€è£½éºº',                  genre:'ã†ã©ã‚“',        element:'æ°´', color:'ç™½', time:'æ˜¼é£Ÿ', desc:'è®ƒå²é‡œæšã’ã†ã©ã‚“ã€‚ã‹ã‘ã†ã©ã‚“ãƒ»å¤©ã·ã‚‰ãŒå®šç•ª' },
        { name:'ãƒ‡ã‚£ãƒƒãƒ‘ãƒ¼ãƒ€ãƒ³',            genre:'ã‚¯ãƒ¬ãƒ¼ãƒ—ãƒ»ã‚¹ã‚¤ãƒ¼ãƒ„', element:'æ°´', color:'ãƒ”ãƒ³ã‚¯', time:'ãŠã‚„ã¤', desc:'1972å¹´å‰µæ¥­ã®ã‚¯ãƒ¬ãƒ¼ãƒ—å°‚é–€åº—ã€‚ã„ã¡ã”ãƒŸãƒ«ã‚¯ç³»ãŒäººæ°—' },
        { name:'é­åŠ›å±‹',                    genre:'ãƒ©ãƒ¼ãƒ¡ãƒ³',      element:'ç«', color:'èŒ¶', time:'æ˜¼ã€œå¤œ', desc:'äº¬éƒ½èƒŒè„‚é†¤æ²¹ãƒ©ãƒ¼ãƒ¡ãƒ³ã€‚ã‚ã£ã•ã‚Šã‚³ã‚¯æ·±ã„å‘³' },
        { name:'ã‚‚ãã¦ãã¡',               genre:'ãƒ©ãƒ¼ãƒ¡ãƒ³',      element:'ç«', color:'èµ¤', time:'æ˜¼ã€œå¤œ', desc:'è±šéª¨ãƒ©ãƒ¼ãƒ¡ãƒ³å°‚é–€åº—ã€‚å®®å´çœŒåˆå‡ºåº—' },
        { name:'ã‚µãƒ–ã‚¦ã‚§ã‚¤',               genre:'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ',  element:'é¢¨', color:'ç·‘', time:'æœã€œå¤œ', desc:'é‡èœãŸã£ã·ã‚Šã‚µãƒ–ã‚¦ã‚§ã‚¤ã€‚ãƒ˜ãƒ«ã‚·ãƒ¼å¿—å‘ã«äººæ°—' },
        { name:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ ã‚³ãƒ¼ãƒ’ãƒ¼ï¼ˆ2Fï¼‰', genre:'ã‚«ãƒ•ã‚§',   element:'é¢¨', color:'ç·‘', time:'æœã€œå¤œ', desc:'2Fã®ã‚¹ã‚¿ãƒã€‚ãƒ•ãƒ©ãƒšãƒãƒ¼ãƒãŒäººæ°—' },
        { name:'ã‚¿ãƒªãƒ¼ã‚ºã‚³ãƒ¼ãƒ’ãƒ¼',          genre:'ã‚«ãƒ•ã‚§',        element:'é¢¨', color:'èµ¤', time:'æœã€œå¤œ', desc:'ã“ã ã‚ã‚Šã®ã‚³ãƒ¼ãƒ’ãƒ¼ã€‚è½ã¡ç€ã„ãŸé›°å›²æ°—' },
        { name:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ ãƒ†ã‚£ãƒ¼ï¼†ã‚«ãƒ•ã‚§', genre:'ã‚«ãƒ•ã‚§ãƒ»ç´…èŒ¶', element:'é¢¨', color:'ç·‘', time:'æœã€œå¤œ', desc:'ãƒ†ã‚£ãƒ¼ã«ç‰¹åŒ–ã—ãŸã‚¹ã‚¿ãƒã€‚ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼ã‚‚äººæ°—' },
        { name:'ãã ã‚‚ã®ã‹ãµã‡',            genre:'ã‚«ãƒ•ã‚§ãƒ»ãƒ•ãƒ«ãƒ¼ãƒ„', element:'æ°´', color:'ãƒ”ãƒ³ã‚¯', time:'æ˜¼ã€œå¤œ', desc:'ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼ãŒäººæ°—ã€‚ã‚ã¾ãŠã†ç³»ãŒçµ¶å“' },
        { name:'ã‚´ãƒ‡ã‚£ãƒ',                  genre:'ã‚¹ã‚¤ãƒ¼ãƒ„',      element:'æ°´', color:'èŒ¶', time:'æ˜¼ã€œå¤œ', desc:'é«˜ç´šãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã€‚ãƒ‰ãƒã‚¤ãƒãƒ§ã‚³ã‚‚ç™»å ´' },
        { name:'éŠ€ã ã“',                    genre:'ãŸã“ç„¼ã',      element:'ç«', color:'èŒ¶', time:'æ˜¼ã€œå¤œ', desc:'å¤–ã‚«ãƒªã‚«ãƒªã®ãŸã“ç„¼ãã€‚ã‚†ãšãƒãƒ³ãŠã‚ã—ãŒäººæ°—' },
    ],
    takeout: [
        { name:'æŸ¿å®‰ ç‰›è‚‰ã©ã¾ã‚“ä¸­',         genre:'å¼å½“ãƒ»æƒ£èœ',    element:'åœŸ', color:'èŒ¶', time:'æ˜¼ã€œå¤œ', desc:'ç‰›è‚‰ã‚’ä½¿ã£ãŸå¼å½“ãƒ»æƒ£èœ' },
        { name:'ãƒ¢ã‚¹ãƒãƒ¼ã‚¬ãƒ¼',              genre:'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰', element:'ç«', color:'èµ¤', time:'æ˜¼ã€œå¤œ', desc:'ã“ã ã‚ã‚Šé‡èœã®ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼' },
    ]
};

const allAeonRestaurants = [
    ...aeonMiyazakiRestaurants.restaurant1F,
    ...aeonMiyazakiRestaurants.foodCourt2F,
    ...aeonMiyazakiRestaurants.takeout
];

// ========== å…¨å›½åœ°åŸŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ ==========
const regionalDB = {
    'å®®å´': {
        spiritual: ['å®®å´ç¥å®®','é’å³¶ç¥ç¤¾','éµœæˆ¸ç¥å®®','æ±Ÿç”°ç¥ç¤¾'],
        nature:    ['é’å³¶','å¤§æ·€å·æ²³å·æ•·','çœŒç·åˆé‹å‹•å…¬åœ’','å €åˆ‡å³ '],
        shopping:  ['ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å®®å´','å®®å´å±±å½¢å±‹','ãƒœãƒ³ãƒ™ãƒ«ã‚¿æ©˜','ãƒ•ãƒ­ãƒ¼ãƒ©ãƒ³ãƒ†å®®å´'],
        cafe:      ['ã‚³ãƒ¡ãƒ€çˆç²ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«ï¼‰','ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«ï¼‰','ã‚¿ãƒªãƒ¼ã‚ºï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«ï¼‰'],
        foods: {
            'ç«': [{name:'ãƒã‚­ãƒ³å—è›®',shop:'ãŠãã‚‰æœ¬åº—ãƒ»åœ°å…ƒé£Ÿå ‚',color:'èŒ¶'},{name:'æ—¥å‘é¶ã®ç‚­ç«ç„¼ã',shop:'ç‚­ç«ç„¼ãå°‚é–€åº—',color:'èŒ¶'},{name:'æšã’ãŸã¦å¤©ã·ã‚‰',shop:'ã¦ã‚“ã·ã‚‰ä¸€ä»£ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«1Fï¼‰',color:'é»„'}],
            'åœŸ': [{name:'å†·ã‚„æ±å®šé£Ÿ',shop:'å®®å´éƒ·åœŸæ–™ç†åº—',color:'ç™½'},{name:'æµ·é®®ãƒ»å’Œé£Ÿå®šé£Ÿ',shop:'ç¯‰åœ°é£Ÿå ‚ æºã¡ã‚ƒã‚“ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«1Fï¼‰',color:'ç™½'},{name:'è®ƒå²ã†ã©ã‚“',shop:'ä¸¸äº€è£½éººï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«2Fï¼‰',color:'ç™½'}],
            'é¢¨': [{name:'ãƒãƒ³ã‚´ãƒ¼ãƒ‘ãƒ•ã‚§',shop:'å®®å´ãƒãƒ³ã‚´ãƒ¼å°‚é–€ã‚«ãƒ•ã‚§',color:'é»„'},{name:'ã‚«ãƒ•ã‚§ãƒ©ãƒ†',shop:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«ï¼‰',color:'ç·‘'},{name:'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ',shop:'ã‚µãƒ–ã‚¦ã‚§ã‚¤ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«2Fï¼‰',color:'ç·‘'}],
            'æ°´': [{name:'ã„ã¡ã”ã‚¯ãƒ¬ãƒ¼ãƒ—',shop:'ãƒ‡ã‚£ãƒƒãƒ‘ãƒ¼ãƒ€ãƒ³ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«2Fï¼‰',color:'ãƒ”ãƒ³ã‚¯'},{name:'ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¹ãƒ ãƒ¼ã‚¸ãƒ¼',shop:'ãã ã‚‚ã®ã‹ãµã‡ï¼ˆã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«2Fï¼‰',color:'ãƒ”ãƒ³ã‚¯'},{name:'å®®å´åœ°é¶ã®ãŸãŸã',shop:'åœ°å…ƒå±…é…’å±‹ãƒ»éƒ·åœŸæ–™ç†åº—',color:'èŒ¶'}],
        }
    },
    'åå¤å±‹': {
        spiritual: ['ç†±ç”°ç¥å®®','åå¤å±‹æ±ç…§å®®','è‹¥å®®å…«å¹¡ç¤¾','çŒ¿æŠ•ç¥ç¤¾'],
        nature:    ['æ±å±±æ¤ç‰©åœ’','é¶´èˆå…¬åœ’','åº„å†…ç·‘åœ°','ååŸå…¬åœ’'],
        shopping:  ['ãƒ©ã‚·ãƒƒã‚¯','çŸ¢å ´ç”ºãƒ»ãƒ‘ãƒ«ã‚³','ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ« Nagoya Noritake Garden','JRã‚²ãƒ¼ãƒˆã‚¿ãƒ¯ãƒ¼'],
        cafe:      ['ã‚³ãƒ¡ãƒ€çˆç²ï¼ˆæœ¬æ‹ åœ°ï¼ï¼‰','ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹åå¤å±‹','ã‚¿ãƒªãƒ¼ã‚ºåå¤å±‹'],
        foods: {
            'ç«': [{name:'æ‰‹ç¾½å…ˆå”æšã’',shop:'é¢¨æ¥åŠãƒ»ä¸–ç•Œã®å±±ã¡ã‚ƒã‚“',color:'èŒ¶'},{name:'ã¿ãã‹ã¤',shop:'çŸ¢å ´ã¨ã‚“ãƒ»åœ°å…ƒã¿ãã‹ã¤åº—',color:'èŒ¶'},{name:'ã©ã¦ç…®',shop:'å±…é…’å±‹ãƒ»ãŠã§ã‚“å±‹',color:'èŒ¶'}],
            'åœŸ': [{name:'ã²ã¤ã¾ã¶ã—',shop:'è“¬è±è»’ãƒ»ã‚ã¤ãŸ',color:'èŒ¶'},{name:'ãã—ã‚ã‚“',shop:'ä½ã‚ˆã—ãƒ»åœ°å…ƒãã—ã‚ã‚“',color:'ç™½'},{name:'å¤©ã‚€ã™',shop:'åƒå¯¿ãƒ»åœ°å…ƒå¼å½“åº—',color:'ç™½'}],
            'é¢¨': [{name:'åå¤å±‹ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°',shop:'ã‚³ãƒ¡ãƒ€çˆç²ï¼ˆæœ¬åº—åœå†…ï¼‰',color:'é»„'},{name:'ã†ã„ã‚ã†',shop:'é’æŸ³ç·æœ¬å®¶ãƒ»å¤§é ˆä¸‡æ¾å¯º',color:'ç™½'},{name:'ã‚«ãƒ•ã‚§ãƒ©ãƒ†',shop:'ã‚³ãƒ¡ãƒ€çˆç²',color:'èŒ¶'}],
            'æ°´': [{name:'ã‚ã‚“ã‹ã‘ã‚¹ãƒ‘',shop:'ãƒ‘ã‚¹ã‚¿ãƒ‡ãƒ»ãƒãƒãƒ»åœ°å…ƒç³»',color:'èŒ¶'},{name:'ã‚¨ãƒ“ãƒ•ãƒ©ã‚¤',shop:'è€èˆ—æ´‹é£Ÿåº—',color:'é»„'},{name:'å°å€‰ãƒˆãƒ¼ã‚¹ãƒˆ',shop:'å–«èŒ¶åº—å…¨èˆ¬',color:'èŒ¶'}],
        }
    },
    'æ–°æ½Ÿ': {
        spiritual: ['ç™½å±±ç¥ç¤¾','å½Œå½¦ç¥ç¤¾','æ˜¥æ—¥å±±ç¥ç¤¾','æ‘ä¸Šå¤©æº€å®®'],
        nature:    ['å¦™é«˜é«˜åŸ','è¶Šå¾Œæ¹¯æ²¢æ¸©æ³‰','ä½æ¸¡å³¶ï¼ˆè¿‘éƒŠï¼‰','æ¸…æ´¥å³¡'],
        shopping:  ['CoCoLoæ–°æ½Ÿ','æ–°æ½Ÿä¼Šå‹¢ä¸¹','ä¸‡ä»£ã‚·ãƒ†ã‚£','ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«æ–°æ½Ÿå—'],
        cafe:      ['ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹æ–°æ½Ÿ','ã‚³ãƒ¡ãƒ€çˆç²æ–°æ½Ÿ','ã‚¿ãƒªãƒ¼ã‚ºæ–°æ½Ÿ'],
        foods: {
            'ç«': [{name:'æ–°æ½ŸBç´šã‚°ãƒ«ãƒ¡ãƒ»ã‚¿ãƒ¬ã‚«ãƒ„ä¸¼',shop:'ã¨ã‚“ã‹ã¤å¤ªéƒãƒ»åœ°å…ƒåº—',color:'èŒ¶'},{name:'ã¸ããã°',shop:'å°å¶‹å±‹ç·æœ¬åº—',color:'èŒ¶'},{name:'æ–°æ½Ÿãƒ©ãƒ¼ãƒ¡ãƒ³ï¼ˆæ¿ƒåšå‘³å™Œï¼‰',shop:'åœ°å…ƒãƒ©ãƒ¼ãƒ¡ãƒ³åº—',color:'èŒ¶'}],
            'åœŸ': [{name:'ã‚³ã‚·ãƒ’ã‚«ãƒªå®šé£Ÿ',shop:'åœ°å…ƒå®šé£Ÿå±‹ãƒ»è¾²å®¶ç›´å£²',color:'ç™½'},{name:'ã®ã£ãºæ±',shop:'éƒ·åœŸæ–™ç†åº—',color:'ç™½'},{name:'ç¬¹å›£å­',shop:'åœ°å…ƒå’Œè“å­åº—',color:'ç·‘'}],
            'é¢¨': [{name:'ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ',shop:'ã‚¤ã‚¿ãƒªã‚¢ãƒ³ï¼ˆå¤ªé™½ãƒ•ãƒ¼ãƒ‰ï¼‰',color:'ç™½'},{name:'ã‚«ãƒ•ã‚§ãƒ©ãƒ†',shop:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹æ–°æ½Ÿ',color:'ç·‘'},{name:'ã½ã£ã½ç„¼ã',shop:'ä¸‡ä»£ã®å±‹å°ãƒ»ç¥­ã‚Š',color:'èŒ¶'}],
            'æ°´': [{name:'æ—¥æœ¬æµ·ã®æµ·é®®',shop:'æœ¬ç”ºå¸‚å ´ãƒ»æµ·é®®å±…é…’å±‹',color:'ç™½'},{name:'å—è›®ã‚¨ãƒ“',shop:'æµ·é®®å¸‚å ´',color:'èµ¤'},{name:'å²©èˆ¹ã®ã‚µãƒ¼ãƒ¢ãƒ³',shop:'æµ·é®®åº—',color:'æ©™'}],
        }
    },
    'å¹³å¡š': {
        spiritual: ['å¹³å¡šå…«å¹¡å®®','ç¥æ˜ç¤¾','å‰é³¥ç¥ç¤¾','é«˜éº—å±±'],
        nature:    ['æ¹˜å—æµ·å²¸','å¤§ç£¯','å¼˜æ³•å±±å…¬åœ’','å¾å¦»å±±å…¬åœ’'],
        shopping:  ['ã‚‰ã‚‰ã½ãƒ¼ã¨æ¹˜å—å¹³å¡š','ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å¹³å¡š','å¹³å¡šé§…å‘¨è¾ºå•†åº—è¡—','ãƒ“ãƒŠã‚¦ã‚©ãƒ¼ã‚¯'],
        cafe:      ['ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹å¹³å¡š','ã‚³ãƒ¡ãƒ€çˆç²å¹³å¡š','ã‚µãƒ³ãƒãƒ«ã‚¯å¹³å¡š'],
        foods: {
            'ç«': [{name:'æ¹˜å—ã—ã‚‰ã™ä¸¼',shop:'æ±Ÿã®å³¶ãƒ»åœ°å…ƒæµ·é®®åº—',color:'ç™½'},{name:'ãƒ­ãƒ¼ã‚¹ãƒˆãƒ“ãƒ¼ãƒ•ä¸¼',shop:'å¹³å¡šé§…å‘¨è¾ºæ´‹é£Ÿåº—',color:'èµ¤'},{name:'ã¨ã‚“ã‹ã¤',shop:'åœ°å…ƒã¨ã‚“ã‹ã¤åº—',color:'èŒ¶'}],
            'åœŸ': [{name:'æ¹˜å—ãªãã•ã®ãŸã“ç„¼ã',shop:'æ±Ÿã®å³¶ãƒ»æµ·å²¸æ²¿ã„',color:'èŒ¶'},{name:'ã‚µãƒ¼ãƒ•ã‚£ãƒ³å¾Œã®å®šé£Ÿ',shop:'æµ·å²¸æ²¿ã„å®šé£Ÿå±‹',color:'ç™½'},{name:'æ¨ªé ˆè³€æµ·è»ã‚«ãƒ¬ãƒ¼',shop:'ã‚«ãƒ¬ãƒ¼å°‚é–€åº—',color:'é»„'}],
            'é¢¨': [{name:'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ',shop:'ã‚µãƒ–ã‚¦ã‚§ã‚¤ãƒ»ãƒ™ãƒ¼ã‚«ãƒªãƒ¼',color:'ç·‘'},{name:'ã‚«ãƒ•ã‚§ãƒ©ãƒ†',shop:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹å¹³å¡š',color:'ç·‘'},{name:'æ¹˜å—ã‚¹ã‚¤ãƒ¼ãƒ„',shop:'æµ·å²¸ã‚«ãƒ•ã‚§',color:'ãƒ”ãƒ³ã‚¯'}],
            'æ°´': [{name:'ç”Ÿã—ã‚‰ã™ä¸¼',shop:'æ±Ÿã®å³¶ãƒ»å¹³å¡šæ¼æ¸¯ç›´å£²',color:'ç™½'},{name:'ã‚¢ã‚¸ãƒ•ãƒ©ã‚¤å®šé£Ÿ',shop:'åœ°å…ƒå®šé£Ÿå±‹',color:'é»„'},{name:'æµ·é®®BBQ',shop:'æµ·å²¸ãƒãƒ¼ãƒ™ã‚­ãƒ¥ãƒ¼å ´',color:'ç™½'}],
        }
    },
    'æ²¼æ´¥': {
        spiritual: ['æ²¼æ´¥æ—¥æç¥ç¤¾','å¯Œå£«å±±æœ¬å®®æµ…é–“å¤§ç¤¾ï¼ˆè¿‘éƒŠï¼‰','ä¸‰å¶‹å¤§ç¤¾','é«˜å°¾å±±ç©‚è¦‹ç¥ç¤¾'],
        nature:    ['æ²¼æ´¥æ¸¯','ä¼Šè±†åŠå³¶','åƒæœ¬æµœå…¬åœ’','é”ç£¨å±±'],
        shopping:  ['ã‚‰ã‚‰ã½ãƒ¼ã¨æ²¼æ´¥','ã‚¤ã‚ªãƒ³æ²¼æ´¥','ãƒ—ãƒ©ã‚¶ãƒ´ã‚§ãƒ«ãƒ‡','ãƒãƒªãƒ³ãƒ‘ãƒ¼ã‚¯'],
        cafe:      ['ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹æ²¼æ´¥','ã‚³ãƒ¡ãƒ€çˆç²æ²¼æ´¥','åœ°å…ƒå–«èŒ¶'],
        foods: {
            'ç«': [{name:'æ²¼æ´¥æ¸¯ã®æ·±æµ·é­šæ–™ç†',shop:'æ²¼æ´¥æ·±æµ·æ°´æ—é¤¨å‘¨è¾ºãƒ»æ¸¯ç”º',color:'é’'},{name:'åœ°ã‚¢ã‚¸ã®ãŸãŸã',shop:'æ²¼æ´¥æ¼æ¸¯é£Ÿå ‚',color:'èŒ¶'},{name:'ä¼Šè±†ã®å±±è‘µæ–™ç†',shop:'é™å²¡ã‚ã•ã³å°‚é–€',color:'ç·‘'}],
            'åœŸ': [{name:'æ¡œæµ·è€ã®ã‹ãæšã’',shop:'å¯Œå£«å·æ²¿ã„ãƒ»åœ°å…ƒå®šé£Ÿ',color:'ãƒ”ãƒ³ã‚¯'},{name:'é™å²¡ãŠã§ã‚“',shop:'åœ°å…ƒãŠã§ã‚“å±‹',color:'èŒ¶'},{name:'ã†ãªã',shop:'æµœæ¾ãƒ»åœ°å…ƒã†ãªãåº—',color:'èŒ¶'}],
            'é¢¨': [{name:'ã¿ã‹ã‚“ã‚¹ã‚¤ãƒ¼ãƒ„',shop:'é™å²¡ã¿ã‹ã‚“å°‚é–€åº—',color:'æ©™'},{name:'ã‚«ãƒ•ã‚§ãƒ©ãƒ†',shop:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹æ²¼æ´¥',color:'ç·‘'},{name:'å¯Œå£«å±±ã‚½ãƒ•ãƒˆ',shop:'å¯Œå£«å±±åœŸç”£åº—',color:'ç™½'}],
            'æ°´': [{name:'ã²ã‚‚ã®å®šé£Ÿ',shop:'æ²¼æ´¥ã²ã‚‚ã®å°‚é–€åº—',color:'èŒ¶'},{name:'é‡‘ç›®é¯›ç…®ä»˜ã‘',shop:'ä¼Šè±†ãƒ»åœ°å…ƒæ–™ç†åº—',color:'èµ¤'},{name:'é§¿æ²³æ¹¾æµ·é®®ä¸¼',shop:'æ²¼æ´¥æ¸¯é£²é£Ÿè¡—',color:'ç™½'}],
        }
    },
    'å²é˜œ': {
        spiritual: ['ä¼Šå¥ˆæ³¢ç¥ç¤¾','å—å®®å¤§ç¤¾','é‡‘ç¥ç¤¾','æ¤¿å¤§ç¥ç¤¾'],
        nature:    ['ç™½å·éƒ·','é£›é¨¨é«˜å±±','éƒ¡ä¸Šå…«å¹¡','é¤Šè€ã®æ»'],
        shopping:  ['ãƒãƒ¼ã‚µ21','å²é˜œé«™å³¶å±‹','ãƒ¢ãƒ¬ãƒ©å²é˜œ','ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å„å‹™åŸ'],
        cafe:      ['ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹å²é˜œ','ã‚³ãƒ¡ãƒ€çˆç²å²é˜œ','ã‚«ãƒ•ã‚§ãƒ»ãƒ‰ãƒ»ã‚¯ãƒªã‚¨'],
        foods: {
            'ç«': [{name:'é£›é¨¨ç‰›ç„¼è‚‰',shop:'é«˜å±±ãƒ»é£›é¨¨ç‰›å°‚é–€åº—',color:'èµ¤'},{name:'é¶ãƒãƒ£ãƒ³ãƒãƒ³',shop:'åœ°å…ƒä¸­è¯',color:'ç™½'},{name:'å‘³å™Œã‹ã¤',shop:'åœ°å…ƒã¨ã‚“ã‹ã¤åº—',color:'èŒ¶'}],
            'åœŸ': [{name:'é£›é¨¨ã®æ¼¬ç‰©ã‚¹ãƒ†ãƒ¼ã‚­',shop:'é«˜å±±éƒ·åœŸæ–™ç†',color:'èŒ¶'},{name:'äº”å¹³é¤…',shop:'é“ã®é§…ãƒ»éƒ·åœŸè“å­åº—',color:'èŒ¶'},{name:'å²é˜œã‚¿ãƒ³ãƒ¡ãƒ³',shop:'åœ°å…ƒãƒ©ãƒ¼ãƒ¡ãƒ³åº—',color:'ç™½'}],
            'é¢¨': [{name:'ã¿ãŸã‚‰ã—å›£å­ï¼ˆç™ºç¥¥åœ°ï¼‰',shop:'ä¸‹å‘‚ãƒ»åœ°å…ƒå’Œè“å­åº—',color:'èŒ¶'},{name:'ã‚«ãƒ•ã‚§ãƒ©ãƒ†',shop:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹å²é˜œ',color:'ç·‘'},{name:'é®ã‚¹ã‚¤ãƒ¼ãƒ„',shop:'éƒ¡ä¸ŠåœŸç”£åº—',color:'é»„'}],
            'æ°´': [{name:'é®æ–™ç†',shop:'é•·è‰¯å·æ²¿ã„æ–™ç†åº—',color:'ç·‘'},{name:'é£›é¨¨ã®æµ·é®®',shop:'å¸‚å ´ãƒ»å±…é…’å±‹',color:'ç™½'},{name:'æœ´è‘‰ã¿ãå®šé£Ÿ',shop:'é«˜å±±éƒ·åœŸæ–™ç†',color:'èŒ¶'}],
        }
    },
    'default': {
        spiritual: ['è¿‘ãã®ç¥ç¤¾','åœ°åŸŸã®æ°ç¥æ§˜','ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆ'],
        nature:    ['è¿‘ãã®å…¬åœ’','å·æ²¿ã„ã®éŠæ­©é“','è‡ªç„¶è±Šã‹ãªå ´æ‰€'],
        shopping:  ['åœ°å…ƒã®ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«','å•†åº—è¡—','åœ°å…ƒã®ãƒãƒ¼ã‚±ãƒƒãƒˆ'],
        cafe:      ['ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹','ã‚³ãƒ¡ãƒ€çˆç²','ã‚¿ãƒªãƒ¼ã‚ºã‚³ãƒ¼ãƒ’ãƒ¼'],
        foods: {
            'ç«': [{name:'ãƒ©ãƒ¼ãƒ¡ãƒ³ãƒ»éººé¡',shop:'åœ°å…ƒãƒ©ãƒ¼ãƒ¡ãƒ³å°‚é–€åº—',color:'èŒ¶'},{name:'æšã’ç‰©ãƒ»å¤©ã·ã‚‰',shop:'åœ°å…ƒå®šé£Ÿå±‹',color:'é»„'},{name:'ç„¼ãé³¥',shop:'åœ°å…ƒç„¼ãé³¥åº—',color:'èŒ¶'}],
            'åœŸ': [{name:'å®šé£Ÿãƒ»å’Œé£Ÿ',shop:'åœ°å…ƒå®šé£Ÿå±‹',color:'ç™½'},{name:'ã†ã©ã‚“ãƒ»ãã°',shop:'ä¸¸äº€è£½éººãƒ»åœ°å…ƒã†ã©ã‚“',color:'ç™½'},{name:'ã”é£¯ã‚‚ã®',shop:'åœ°å…ƒé£²é£Ÿåº—',color:'ç™½'}],
            'é¢¨': [{name:'ã‚«ãƒ•ã‚§ãƒ©ãƒ†ãƒ»ã‚¹ã‚¤ãƒ¼ãƒ„',shop:'ã‚¹ã‚¿ãƒ¼ãƒãƒƒã‚¯ã‚¹ãƒ»ã‚«ãƒ•ã‚§',color:'ç·‘'},{name:'ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ',shop:'ã‚µãƒ–ã‚¦ã‚§ã‚¤ãƒ»ãƒ™ãƒ¼ã‚«ãƒªãƒ¼',color:'ç·‘'},{name:'ãƒ‘ãƒ³ãƒ»è»½é£Ÿ',shop:'åœ°å…ƒãƒ™ãƒ¼ã‚«ãƒªãƒ¼',color:'é»„'}],
            'æ°´': [{name:'æµ·é®®ãƒ»å¯¿å¸',shop:'åœ°å…ƒæµ·é®®åº—ãƒ»å›è»¢å¯¿å¸',color:'ç™½'},{name:'ãƒ•ãƒ«ãƒ¼ãƒ„ã‚¹ã‚¤ãƒ¼ãƒ„',shop:'ã‚«ãƒ•ã‚§ãƒ»ãƒ•ãƒ«ãƒ¼ãƒ„ãƒ‘ãƒ¼ãƒ©ãƒ¼',color:'ãƒ”ãƒ³ã‚¯'},{name:'å†·ã‚„ã—éºº',shop:'åœ°å…ƒé£²é£Ÿåº—',color:'ç™½'}],
        }
    }
};

function detectRegion(situation) {
    const keys = Object.keys(regionalDB).filter(k => k !== 'default');
    for (const key of keys) {
        if (situation.includes(key)) return key;
    }
    const aliases = {
        'ã¿ã‚„ã–ã':'å®®å´','ãªã”ã‚„':'åå¤å±‹','ã«ã„ãŒãŸ':'æ–°æ½Ÿ',
        'ã²ã‚‰ã¤ã‹':'å¹³å¡š','ã¬ã¾ã¥':'æ²¼æ´¥','ããµ':'å²é˜œ',
        'ã‚¤ã‚ªãƒ³':'å®®å´','å®®å´å¸‚':'å®®å´','åå¤å±‹å¸‚':'åå¤å±‹',
        'æ–°æ½Ÿå¸‚':'æ–°æ½Ÿ','å¹³å¡šå¸‚':'å¹³å¡š','æ²¼æ´¥å¸‚':'æ²¼æ´¥','é«˜å±±å¸‚':'å²é˜œ'
    };
    for (const [alias, region] of Object.entries(aliases)) {
        if (situation.includes(alias)) return region;
    }
    return 'default';
}

// ========== ãƒ¡ã‚¤ãƒ³å ã„è¨ˆç®— ==========
function calculateFortune(zodiac, blood, eto, birthdate, situation, now) {
    const zData = zodiacBase[zodiac] || zodiacBase['ç‰¡ç¾Šåº§'];
    let base = zData.base;
    base += (bloodBonus[blood] || 4);
    base += (etoBonus[eto] || 4);
    base += dayBonus[now.getDay()];
    const lp = getLifePath(birthdate);
    base += (lp % 5);
    const moonPhase = getMoonPhase(now);
    base += moonPhase.bonus;
    const birthYear = birthdate ? parseInt(birthdate.split('-')[0]) : 1993;
    const kyusei = getKyusei(birthYear);
    const rokuyo = getRokuyo(now);
    const rokuyoBonus = {'å¤§å®‰':8,'å‹å¼•':5,'å…ˆå‹':4,'å…ˆè² ':3,'èµ¤å£':2,'ä»æ»…':1};
    base += (rokuyoBonus[rokuyo] || 4);
    base = Math.min(99, Math.max(65, base));
    const dayKan = getDayKan(now);
    const luckyTimes = calcLuckyTimes(now, zodiac, blood, eto);
    const places = calcLuckyPlaces(zData.element, situation, now, base);
    const foods = calcLuckyFoods(zData.element, zodiac, now, situation);
    const divinations = generateDivinationMessages(zodiac, blood, eto, rokuyo, kyusei, lp, dayKan, moonPhase, base, now);
    const overall = generateOverallMessage(zodiac, rokuyo, base, now, situation);
    return { base, luckyTimes, places, foods, divinations, overall, rokuyo, kyusei, lp, moonPhase };
}

function getMoonPhase(now) {
    const knownNew = new Date(2000, 0, 6);
    const diff = (now - knownNew) / 86400000;
    const cycle = diff % 29.53;
    if (cycle < 1.5 || cycle > 28) return { phase:'æ–°æœˆ', emoji:'ğŸŒ‘', bonus:6 };
    if (cycle < 7.5) return { phase:'ä¸‰æ—¥æœˆ', emoji:'ğŸŒ’', bonus:4 };
    if (cycle < 9.5) return { phase:'ä¸Šå¼¦ã®æœˆ', emoji:'ğŸŒ“', bonus:5 };
    if (cycle < 14) return { phase:'åä¸‰å¤œ', emoji:'ğŸŒ”', bonus:6 };
    if (cycle < 16) return { phase:'æº€æœˆ', emoji:'ğŸŒ•', bonus:8 };
    if (cycle < 22) return { phase:'ä¸‹å¼¦ã®æœˆ', emoji:'ğŸŒ—', bonus:4 };
    return { phase:'æ™¦æ—¥æœˆ', emoji:'ğŸŒ˜', bonus:3 };
}

function calcLuckyTimes(now, zodiac, blood, eto) {
    const h = now.getHours();
    const timeSlots = [
        { time:'6:00-9:00',  start:6  },
        { time:'9:00-12:00', start:9  },
        { time:'12:00-15:00',start:12 },
        { time:'15:00-18:00',start:15 },
        { time:'18:00-21:00',start:18 },
        { time:'21:00-24:00',start:21 },
    ];
    return timeSlots.map(slot => {
        let score = 70 + getHourScore(slot.start);
        const zData = zodiacBase[zodiac];
        if (zData) {
            const ln = zData.luckyNum;
            if (slot.start % 3 === ln % 3) score += 5;
        }
        if (Math.abs(slot.start - h) <= 2) score += 3;
        score = Math.min(99, score);
        const label = score >= 90 ? 'ğŸ”¥æœ€å¼·ã®ãƒ”ãƒ¼ã‚¯ï¼' : score >= 85 ? 'â­å¥½èª¿ï¼' : score >= 80 ? 'â†‘ä¸Šæ˜‡ä¸­' : 'â†’å®‰å®š';
        return { time: slot.time, score, label };
    }).sort((a,b) => b.score - a.score).slice(0, 4);
}

function calcLuckyPlaces(element, situation, now, score) {
    const region = detectRegion(situation);
    const rdb = regionalDB[region] || regionalDB['default'];
    const elementToCategory = {
        'ç«': ['spiritual','nature','shopping','cafe'],
        'åœŸ': ['shopping','cafe','nature','spiritual'],
        'é¢¨': ['cafe','shopping','spiritual','nature'],
        'æ°´': ['nature','spiritual','cafe','shopping'],
    };
    const cats = elementToCategory[element] || ['spiritual','nature','shopping','cafe'];
    const directions = { spiritual:'åŒ—', nature:'æ±', shopping:'å—', cafe:'å—æ±' };
    const reasons = {
        spiritual: 'ç¥è–ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒé«˜ã¾ã‚Šã€é¡˜ã„ãŒå¶ã„ã‚„ã™ã„è–åœ°ã§ã™ã€‚',
        nature:    'è‡ªç„¶ã®ãƒ‘ãƒ¯ãƒ¼ãŒé‹æ°—ã‚’æµ„åŒ–ã—ã€æ–°ãŸãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ä¸ãˆã¦ãã‚Œã¾ã™ã€‚',
        shopping:  'é‡‘é‹ã¨äººã¨ã®ç¸ãŒçµã°ã‚Œã‚„ã™ã„ã€è³‘ã‚ã„ã®ã‚ã‚‹å ´æ‰€ã§ã™ã€‚',
        cafe:      'ã‚†ã£ãã‚Šã¨æµã‚Œã‚‹æ™‚é–“ã®ä¸­ã§ã€è‰¯ç¸ã¨å‡ºä¼šã„ã‚’å¼•ãå¯„ã›ã¾ã™ã€‚',
    };
    return cats.slice(0,3).map((cat, i) => {
        const spots = rdb[cat] || regionalDB['default'][cat];
        const spot = spots[now.getDate() % spots.length];
        return {
            rank: i+1,
            name: cat === 'spiritual' ? 'ç¥ç¤¾ãƒ»ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆ' : cat === 'nature' ? 'è‡ªç„¶ã‚¹ãƒãƒƒãƒˆ' : cat === 'shopping' ? 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢' : 'ã‚«ãƒ•ã‚§ãƒ»å–«èŒ¶åº—',
            category: cat === 'spiritual' ? 'â›©ï¸ ç¥ç¤¾ãƒ»è–åœ°' : cat === 'nature' ? 'ğŸŒ¿ è‡ªç„¶ãƒ»å…¬åœ’' : cat === 'shopping' ? 'ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°' : 'â˜• ã‚«ãƒ•ã‚§',
            nearby: spot,
            reason: reasons[cat],
            direction: directions[cat],
        };
    });
}

function calcLuckyFoods(element, zodiac, now, situation) {
    const region = detectRegion(situation);
    const rdb = regionalDB[region] || regionalDB['default'];
    const foods = (rdb.foods && rdb.foods[element]) || regionalDB['default'].foods[element] || regionalDB['default'].foods['æ°´'];
    const seed = now.getDate() + now.getHours();
    const sorted = foods.map((f, i) => ({ ...f, score: 70 + ((seed + i * 7) % 25), time: f.time || 'æ˜¼ã€œå¤œ' }))
        .sort((a, b) => b.score - a.score);
    const region_name = region !== 'default' ? region : '';
    return sorted.slice(0, 3).map((f, i) => ({
        rank: i+1,
        name: f.name,
        color: f.color,
        shop: f.shop,
        reason: `${element}ã®æ°—ã‚’æŒã¤ã‚ãªãŸã«æœ€é©ã€‚${region_name ? region_name + 'ã®' : ''}ä»Šæ—¥ã®é‹æ°—ã¨ç›¸æ€§ãŒæŠœç¾¤ã§ã™ã€‚`,
        best_time: f.time || 'æ˜¼ã€œå¤œ'
    }));
}

function generateAllShopsHTML() {
    const cats = [
        { key: 'restaurant1F', label: 'ğŸ½ï¸ 1Fãƒ¬ã‚¹ãƒˆãƒ©ãƒ³è¡—', color: '#C9A84C' },
        { key: 'foodCourt2F',  label: 'ğŸ›’ 2Fãƒ•ãƒ¼ãƒ‰ã‚³ãƒ¼ãƒˆï¼ˆFood Forestï¼‰', color: '#8B5CF6' },
        { key: 'takeout',      label: 'ğŸ¥¡ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ»ãã®ä»–', color: '#FF6B9D' },
    ];
    return cats.map(cat => `
        <div style="margin-bottom:15px;">
            <div style="font-size:.75rem;color:${cat.color};letter-spacing:.1em;margin-bottom:10px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.08);">
                ${cat.label}
            </div>
            ${aeonMiyazakiRestaurants[cat.key].map(r => `
            <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);">
                <div style="font-size:1rem;">${{
                    'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³':'ğŸ´','ã‚«ãƒ•ã‚§':'â˜•','æµ·é®®ãƒ»å’Œé£Ÿ':'ğŸŸ','å¤©ã·ã‚‰':'ğŸ¤',
                    'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰':'ğŸ”','æƒ£èœãƒ»ç„¼ãé³¥':'ğŸ—','æƒ£èœ':'ğŸ¥˜','ã†ã©ã‚“':'ğŸœ',
                    'ã‚¯ãƒ¬ãƒ¼ãƒ—ãƒ»ã‚¹ã‚¤ãƒ¼ãƒ„':'ğŸ“','ãƒ©ãƒ¼ãƒ¡ãƒ³':'ğŸœ','ã‚µãƒ³ãƒ‰ã‚¤ãƒƒãƒ':'ğŸ¥–',
                    'ã‚«ãƒ•ã‚§ãƒ»ç´…èŒ¶':'ğŸ«–','ã‚«ãƒ•ã‚§ãƒ»ãƒ•ãƒ«ãƒ¼ãƒ„':'ğŸ“','ã‚¹ã‚¤ãƒ¼ãƒ„':'ğŸ«',
                    'ãŸã“ç„¼ã':'ğŸ™','å¼å½“ãƒ»æƒ£èœ':'ğŸ±','ã‚«ãƒ•ã‚§ãƒ»æ´‹é£Ÿ':'ğŸ'
                }[r.genre] || 'ğŸ½ï¸'}</div>
                <div style="flex:1;">
                    <div style="font-size:.85rem;font-weight:700;color:#F0E6FF;">${r.name}</div>
                    <div style="font-size:.7rem;color:#9A8AB0;">${r.genre} | ${r.desc}</div>
                </div>
            </div>`).join('')}
        </div>
    `).join('');
}

function generateDivinationMessages(zodiac, blood, eto, rokuyo, kyusei, lp, dayKan, moonPhase, score, now) {
    const zData = zodiacBase[zodiac];
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    return [
        {
            name: `ğŸŒŸ è¥¿æ´‹å æ˜Ÿè¡“ï¼ˆ${zodiac}ãƒ»${zData.planet}æ”¯é…ï¼‰`,
            text: `${zData.planet}ã®å½±éŸ¿ã§${score >= 88 ? 'å¼·åŠ›ãªå¹¸é‹ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæµã‚Œã¦ã„ã¾ã™ã€‚ç©æ¥µçš„ãªè¡Œå‹•ãŒå‰ã€‚' : score >= 82 ? 'å®‰å®šã—ãŸé‹æ°—ã®ä¸­ã€ç›´æ„Ÿã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã§å¥½æ©Ÿã‚’æ´ã‚ã¾ã™ã€‚' : 'æ…é‡ã•ã®ä¸­ã«ã‚‚å‰é€²ã™ã‚‹å‹‡æ°—ã‚’æŒã£ã¦ã€‚ãƒãƒ£ãƒ³ã‚¹ã¯å¿…ãšæ¥ã¾ã™ã€‚'}ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ã¯${zData.luckyColor}ã€‚`
        },
        {
            name: `ğŸ”¢ æ•°ç§˜è¡“ï¼ˆãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹${lp}ï¼‰`,
            text: `ã‚ãªãŸã®ãƒ©ã‚¤ãƒ•ãƒ‘ã‚¹æ•°${lp}ã¯${lp <= 3 ? 'å‰µé€ ã¨è¡¨ç¾' : lp <= 6 ? 'æ„›ã¨å¥‰ä»•' : lp <= 9 ? 'æ™ºæ…§ã¨å®Œæˆ' : 'ç›´æ„Ÿã¨ãƒã‚¹ã‚¿ãƒ¼'}ã®æ•°ã€‚ä»Šæ—¥ã®æ•°å€¤${now.getDate()}ã¨ã®ç›¸æ€§ã¯${(now.getDate() + lp) % 2 === 0 ? 'â—æŠœç¾¤' : 'â—‹è‰¯å¥½'}ã§ã™ã€‚`
        },
        {
            name: `â­ ä¹æ˜Ÿæ°—å­¦ï¼ˆ${kyusei}ï¼‰`,
            text: `${kyusei}ã®æ–¹ã¯ä»Šæ—¥ã€${score >= 88 ? 'é‹å‘½çš„ãªå‡ºä¼šã„ã¨å¥½æ©ŸãŒé‡ãªã‚‹å¼·é‹ã®æ—¥ã€‚' : 'ç€å®Ÿãªå‰é€²ãŒå‰ã€‚'}${days[now.getDay()]}æ›œæ—¥ã®${kyusei}ã¯ç‰¹ã«${now.getDay() === 3 || now.getDay() === 5 ? 'å¯¾äººé‹ãŒé«˜ã¾ã‚Šã¾ã™' : 'æ´»å‹•é‹ãŒè‰¯å¥½ã§ã™'}ã€‚`
        },
        {
            name: `ğŸ“… å…­æ›œï¼ˆ${rokuyo}ï¼‰`,
            text: `æœ¬æ—¥ã¯${rokuyo}ã€‚${{ 'å¤§å®‰':'ä½•äº‹ã«ã‚‚æœ€è‰¯ã®æ—¥ã€‚æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ã‚‹ã®ã«æœ€é©ã§ã™ã€‚', 'å‹å¼•':'å‹ã‚’å¼•ãå¯„ã›ã‚‹å‰æ—¥ã€‚äººã¨ã®ç¸ãŒæ·±ã¾ã‚Šã¾ã™ã€‚', 'å…ˆå‹':'åˆå‰ä¸­ãŒç‰¹ã«å‰ã€‚ç´ æ—©ã„è¡Œå‹•ãŒé–‹é‹ã®ã‚«ã‚®ã€‚', 'å…ˆè² ':'åˆå¾Œã‹ã‚‰é‹æ°—ä¸Šæ˜‡ã€‚ç„¦ã‚‰ãšå¾…ã¤ã“ã¨ãŒå‰ã€‚', 'èµ¤å£':'æ­£åˆã®ã¿å‰ã€‚æ…é‡ã«è¡Œå‹•ã—ã¾ã—ã‚‡ã†ã€‚', 'ä»æ»…':'å¤‰åŒ–ã¨è»¢æ›ã®æ—¥ã€‚æ–°ãŸãªå§‹ã¾ã‚Šã¸ã®æº–å‚™æœŸé–“ã€‚' }[rokuyo]}`
        },
        {
            name: `ğŸŒ™ æœˆç›¸ï¼ˆ${moonPhase.phase}${moonPhase.emoji}ï¼‰`,
            text: `${moonPhase.phase}ã®ä»Šæ—¥ã¯${{ 'æº€æœˆ':'ç›´æ„Ÿã¨æ„Ÿæƒ…ãŒæœ€é«˜æ½®ã€‚æ‹æ„›é‹ãƒ»å¯¾äººé‹ãŒç‰¹ã«å¼·ã¾ã‚Šã¾ã™ã€‚', 'æ–°æœˆ':'æ–°ã—ã„å§‹ã¾ã‚Šã«æœ€é©ã€‚é¡˜ã„äº‹ã‚’ã™ã‚‹ã®ã«çµ¶å¥½ã®æ—¥ã€‚', 'ä¸‰æ—¥æœˆ':'ç‰©äº‹ãŒã‚†ã£ãã‚Šã¨å‹•ãå§‹ã‚ã¾ã™ã€‚ç„¦ã‚‰ãšè‚²ã¦ã‚‹æ„è­˜ã§ã€‚', 'ä¸Šå¼¦ã®æœˆ':'è¡Œå‹•åŠ›ãŒé«˜ã¾ã‚Šã¾ã™ã€‚ç©æ¥µçš„ã«å‹•ãã“ã¨ã§é‹ãŒé–‹ã‘ã¾ã™ã€‚', 'åä¸‰å¤œ':'æˆæœãŒè¦‹ãˆå§‹ã‚ã‚‹æ™‚æœŸã€‚ã‚‚ã†ã²ã¨è¸ã‚“å¼µã‚ŠãŒå¤§åˆ‡ã€‚', 'ä¸‹å¼¦ã®æœˆ':'æ‰‹æ”¾ã—ã¨æ•´ç†ã®æ™‚ã€‚ä¸è¦ãªã‚‚ã®ã‚’æ–­æ¨é›¢ã™ã‚‹ã¨é‹æ°—UPã€‚', 'æ™¦æ—¥æœˆ':'é™ã‹ã«å†…çœã™ã‚‹æ™‚æœŸã€‚æ¬¡ã®æ–°æœˆã«å‘ã‘ã¦æº–å‚™ã‚’ã€‚' }[moonPhase.phase] || 'é™ã‹ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ä¸­ã§ã€è‡ªåˆ†ã‚’è¦‹ã¤ã‚ç›´ã™è‰¯ã„æ©Ÿä¼šã§ã™ã€‚'}`
        },
        {
            name: `ğŸ€„ å››æŸ±æ¨å‘½ï¼ˆæ—¥å¹²ï¼š${dayKan}ï¼‰`,
            text: `ä»Šæ—¥ã®æ—¥å¹²ã€Œ${dayKan}ã€ã¯ã‚ãªãŸã®å¹²æ”¯ã€Œ${document.getElementById('eto').value}ã€ã¨ã®ç›¸æ€§ãŒ${{ 'ç”²':'â—', 'ä¹™':'â—‹', 'ä¸™':'â—', 'ä¸':'â—‹', 'æˆŠ':'â–³', 'å·±':'â—‹', 'åºš':'â—', 'è¾›':'â—‹', 'å£¬':'â—', 'ç™¸':'â–³' }[dayKan]}ã€‚${{ 'ç”²':'åŠ›å¼·ã„æˆé•·ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼', 'ä¹™':'æŸ”è»Ÿã§é©å¿œåŠ›ã®ã‚ã‚‹', 'ä¸™':'æ˜ã‚‹ãæƒ…ç†±çš„ãª', 'ä¸':'ç¹Šç´°ã§æ„Ÿå—æ€§è±Šã‹ãª', 'æˆŠ':'å®‰å®šã¨å®Ÿç›´ãª', 'å·±':'ç´°ã‚„ã‹ã§ä¸å¯§ãª', 'åºš':'é‹­ãè¡Œå‹•åŠ›ã‚ã‚‹', 'è¾›':'æ´—ç·´ã•ã‚ŒãŸç¾ã—ã„', 'å£¬':'å¤§ããªæµã‚Œã‚’æŒã¤', 'ç™¸':'æ¸…ã‚‰ã‹ã§ç›´æ„Ÿçš„ãª' }[dayKan]}ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒä»Šæ—¥ã‚’å½©ã‚Šã¾ã™ã€‚`
        },
        {
            name: `ğŸ©¸ è¡€æ¶²å‹å ã„ï¼ˆ${blood}å‹ï¼‰`,
            text: `${{ 'A':'å‡ å¸³é¢ã§èª å®ŸãªAå‹', 'B':'è‡ªç”±ã§å€‹æ€§çš„ãªBå‹', 'O':'å¤§ã‚‰ã‹ã§ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚ã‚‹Oå‹', 'AB':'äºŒé¢æ€§ã‚’æŒã¤æ„Ÿå—æ€§è±Šã‹ãªABå‹' }[blood]}ã®ä»Šæ—¥ã¯${{ 'A':'ä¸å¯§ãªè¡Œå‹•ãŒè©•ä¾¡ã•ã‚Œã‚‹æ—¥ã€‚', 'B':'ç›´æ„Ÿã‚’ä¿¡ã˜ã¦å‹•ãã¨å‰ã€‚', 'O':'å‘¨å›²ã¨ã®èª¿å’ŒãŒé‹æ°—ã‚’é«˜ã‚ã‚‹ã€‚', 'AB':'ä¸¡é¢ã®ãƒãƒ©ãƒ³ã‚¹ãŒå–ã‚ŒãŸæœ€è‰¯ã®æ—¥ã€‚' }[blood]}ç‰¹ã«${score >= 88 ? 'åˆå¾Œã‹ã‚‰å¤•æ–¹ã«ã‹ã‘ã¦é‹æ°—ãŒæœ€é«˜æ½®ã«é”ã—ã¾ã™ã€‚' : 'æœã®è¡Œå‹•ãŒä¸€æ—¥ã®é‹æ°—ã‚’æ±ºã‚ã¾ã™ã€‚'}`
        },
    ];
}

function generateOverallMessage(zodiac, rokuyo, score, now, situation) {
    const days = ['æ—¥æ›œæ—¥','æœˆæ›œæ—¥','ç«æ›œæ—¥','æ°´æ›œæ—¥','æœ¨æ›œæ—¥','é‡‘æ›œæ—¥','åœŸæ›œæ—¥'];
    const msgs = [
        `${days[now.getDay()]}ã®${zodiac}ã¯é‹æ°—${score}ç‚¹ã€‚${rokuyo}ã¨é‡ãªã‚Šã€${score >= 88 ? 'ç‰¹åˆ¥ãªå‡ºä¼šã„ã¨å¹¸é‹ãŒè¨ªã‚Œã‚‹æœ€é«˜ã®ä¸€æ—¥ã§ã™ã€‚ç©æ¥µçš„ãªè¡Œå‹•ãŒã‚ãªãŸã®é‹å‘½ã‚’å¤‰ãˆã¾ã™ã€‚' : score >= 82 ? 'ç€å®Ÿãªå‰é€²ã¨è‰¯ç¸ã«æµã¾ã‚Œã‚‹æ—¥ã§ã™ã€‚ç¬‘é¡”ã‚’å¿˜ã‚Œãšã«ã€‚' : 'ç©ã‚„ã‹ãªé‹æ°—ã®ä¸­ã«ç¢ºã‹ãªãƒãƒ£ãƒ³ã‚¹ãŒæ½œã‚“ã§ã„ã¾ã™ã€‚'}`,
        `${situation ? situation + 'ã«ã„ã‚‹ä»Šã€' : ''}å®‡å®™ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒã‚ãªãŸã«å¾®ç¬‘ã‚“ã§ã„ã¾ã™ã€‚${score >= 88 ? 'é‹å‘½çš„ãªå‡ºä¼šã„ã®äºˆæ„Ÿå¤§ã€‚' : 'è‰¯ã„ã“ã¨ãŒèµ·ã“ã‚‹äºˆæ„Ÿã‚’å¤§åˆ‡ã«ã€‚'}ä»Šæ—¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€Œ${score >= 88 ? 'ç¸ãƒ»å‡ºä¼šã„ãƒ»å¥‡è·¡' : score >= 82 ? 'å‰é€²ãƒ»æˆé•·ãƒ»ç¬‘é¡”' : 'æº–å‚™ãƒ»å†…çœãƒ»æ„Ÿè¬'}ã€ã§ã™ã€‚`,
    ];
    return msgs[now.getDate() % msgs.length];
}

// ========== å ã„å®Ÿè¡Œ ==========
function startFortune() {
    const zodiac = document.getElementById('zodiac').value;
    const blood = document.getElementById('blood-type').value;
    const eto = document.getElementById('eto').value;
    const birthdate = document.getElementById('birthdate').value || '1993-04-14';
    const situation = document.getElementById('situation').value || currentLocation || 'å®®å´å¸‚';
    const now = new Date();
    document.getElementById('loading').classList.add('show');
    document.getElementById('result').classList.remove('show');
    setTimeout(() => {
        const data = calculateFortune(zodiac, blood, eto, birthdate, situation, now);
        displayResult(data, now, situation);
        document.getElementById('loading').classList.remove('show');
    }, 1800);
}

// ========== çµæœè¡¨ç¤º ==========
function displayResult(data, now, location) {
    const days = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    const m = now.getMonth()+1, d = now.getDate();
    const h = String(now.getHours()).padStart(2,'0');
    const min = String(now.getMinutes()).padStart(2,'0');
    const dateStr = `${m}/${d}(${days[now.getDay()]}) ${h}:${min}`;
    const resultDiv = document.getElementById('result');

    let html = `
    <div class="result-card card-overall">
        <div class="card-header">
            <div class="card-icon">ğŸŒŸ</div>
            <div>
                <div class="card-title">ä»Šæ—¥ã®ç·åˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                <div class="card-subtitle">${dateStr} | ${location} | ${data.rokuyo} ${data.moonPhase.emoji}</div>
            </div>
        </div>
        <div class="overall-msg">${data.overall}</div>
    </div>
    <div class="result-card card-time">
        <div class="card-header">
            <div class="card-icon">â°</div>
            <div>
                <div class="card-title">ãƒ©ãƒƒã‚­ãƒ¼ã‚¿ã‚¤ãƒ </div>
                <div class="card-subtitle">ä¹æ˜Ÿæ°—å­¦ãƒ»æ•°ç§˜è¡“ãƒ»æ˜Ÿåº§ã‚’çµ±åˆã—ã¦ç®—å‡º</div>
            </div>
        </div>
        <div class="time-grid">
            ${data.luckyTimes.map(t => `
            <div class="time-item">
                <div class="time-range">${t.time}</div>
                <div class="time-score-val" style="color:${t.score>=90?'#FFD700':t.score>=85?'#C9A84C':'#9A8AB0'}">${t.score}ç‚¹</div>
                <div class="time-label">${t.label}</div>
            </div>`).join('')}
        </div>
    </div>
    <div class="result-card card-place">
        <div class="card-header">
            <div class="card-icon">ğŸ“</div>
            <div>
                <div class="card-title">ãƒ©ãƒƒã‚­ãƒ¼ã‚¹ãƒãƒƒãƒˆ</div>
                <div class="card-subtitle">é¢¨æ°´ãƒ»ä¹æ˜Ÿæ°—å­¦ã«åŸºã¥ãé–‹é‹ã®å ´æ‰€</div>
            </div>
        </div>
        ${data.places.map(p => `
        <div class="place-item">
            <div class="place-rank">ğŸ† ç¬¬${p.rank}ä½ | ${p.category} | ${p.direction}ã®æ–¹è§’ãŒå‰</div>
            <div class="place-name">${p.name}</div>
            <div class="place-nearby">ğŸ“ è¿‘ãï¼š${p.nearby}</div>
            <div class="place-reason">${p.reason}</div>
        </div>`).join('')}
    </div>
    <div class="result-card card-food">
        <div class="card-header">
            <div class="card-icon">ğŸ½ï¸</div>
            <div>
                <div class="card-title">ãƒ©ãƒƒã‚­ãƒ¼ãƒ•ãƒ¼ãƒ‰</div>
                <div class="card-subtitle">äº”è¡Œèª¬ãƒ»æ˜Ÿåº§ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã«åŸºã¥ãé–‹é‹é£Ÿ</div>
            </div>
        </div>
        ${data.foods.map(f => `
        <div class="food-item">
            <div class="food-rank">ğŸ€ ç¬¬${f.rank}ä½ | ${f.color}ã®é£Ÿã¹ç‰© | ${f.best_time}</div>
            <div class="food-name">${f.name}</div>
            <div class="food-shop">ğŸª ${f.shop}</div>
            <div class="food-reason">${f.reason}</div>
        </div>`).join('')}
    </div>
    <div class="result-card card-divination">
        <div class="card-header">
            <div class="card-icon">ğŸ”®</div>
            <div>
                <div class="card-title">å è¡“åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                <div class="card-subtitle">7ç¨®é¡ã®å è¡“ã‚’çµ±åˆ</div>
            </div>
        </div>
        ${data.divinations.map(d => `
        <div class="div-item">
            <div class="div-name">${d.name}</div>
            <div class="div-text">${d.text}</div>
        </div>`).join('')}
    </div>`;

    const region = detectRegion(location);
    const rdb = regionalDB[region] || regionalDB['default'];
    const isInMiyazaki = region === 'å®®å´';

    if (isInMiyazaki) {
        html += `
        <div class="result-card" style="background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(10,6,20,.9));margin:15px 0;">
            <div class="card-header">
                <div class="card-icon">ğŸª</div>
                <div>
                    <div class="card-title">ã‚¤ã‚ªãƒ³ãƒ¢ãƒ¼ãƒ«å®®å´ å…¨é£²é£Ÿåº—ä¸€è¦§</div>
                    <div class="card-subtitle">å…¨${allAeonRestaurants.length}åº—èˆ— å®Œå…¨åéŒ²</div>
                </div>
            </div>
            ${generateAllShopsHTML()}
        </div>`;
    } else if (region !== 'default') {
        const allFoods = Object.values(rdb.foods || {}).flat();
        html += `
        <div class="result-card" style="background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(10,6,20,.9));margin:15px 0;">
            <div class="card-header">
                <div class="card-icon">ğŸ—¾</div>
                <div>
                    <div class="card-title">${region}ã®ã‚°ãƒ«ãƒ¡æƒ…å ±</div>
                    <div class="card-subtitle">å…¨${allFoods.length}ãƒ¡ãƒ‹ãƒ¥ãƒ¼åéŒ²</div>
                </div>
            </div>
            <div style="margin-bottom:12px;">
                <div style="font-size:.7rem;color:var(--gold);letter-spacing:.1em;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.08);">ğŸ½ï¸ ${region}ã®ãŠã™ã™ã‚ã‚°ãƒ«ãƒ¡ãƒ»ãŠåº—</div>
                ${allFoods.map(f => `
                <div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);">
                    <div style="font-size:1rem;min-width:24px;">ğŸ´</div>
                    <div style="flex:1;">
                        <div style="font-size:.85rem;font-weight:700;color:#F0E6FF;">${f.name}</div>
                        <div style="font-size:.7rem;color:var(--gold);">ğŸ“ ${f.shop}</div>
                    </div>
                </div>`).join('')}
            </div>
            <div style="margin-top:15px;">
                <div style="font-size:.7rem;color:var(--accent);letter-spacing:.1em;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.08);">â›©ï¸ ${region}ã®ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆãƒ»ãŠã§ã‹ã‘æƒ…å ±</div>
                ${['spiritual','nature','shopping','cafe'].map(cat => {
                    const spots = rdb[cat] || [];
                    const icon = {spiritual:'â›©ï¸',nature:'ğŸŒ¿',shopping:'ğŸ›ï¸',cafe:'â˜•'}[cat];
                    const label = {spiritual:'ç¥ç¤¾ãƒ»ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒãƒƒãƒˆ',nature:'è‡ªç„¶ãƒ»å…¬åœ’',shopping:'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°',cafe:'ã‚«ãƒ•ã‚§'}[cat];
                    return `
                    <div style="margin-bottom:8px;">
                        <div style="font-size:.7rem;color:var(--muted);margin-bottom:4px;">${icon} ${label}</div>
                        ${spots.map(s => `<div style="font-size:.8rem;color:var(--text);padding:3px 8px;">ãƒ»${s}</div>`).join('')}
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    }

    resultDiv.innerHTML = html;
    resultDiv.classList.add('show');
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// åˆæœŸè¨­å®š
document.getElementById('zodiac').value = 'ç‰¡ç¾Šåº§';
</script>
</body>
</html>
